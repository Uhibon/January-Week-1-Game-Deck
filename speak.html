<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1,viewport-fit=cover" />
<title>Booha Speak & Repeat – January Week 1</title>
<meta name="theme-color" content="#0b1530" />
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet" />

<!-- Preload score sounds to avoid cut-offs -->
<link rel="preload" as="audio" href="assets/audio/0-43.mp3" />
<link rel="preload" as="audio" href="assets/audio/44-74.mp3" />
<link rel="preload" as="audio" href="assets/audio/75-99.mp3" />
<link rel="preload" as="audio" href="assets/audio/100.mp3" />

<style>
:root{--bg:#0b1530;--ink:#fff;--outline:#ffffff26;--radius:26px;}
*{box-sizing:border-box;margin:0}
body{background:var(--bg);color:var(--ink);font-family:"Noto Sans JP",sans-serif;}
header{text-align:center;padding:24px 10px}
.h1{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(34px,6vw,54px)}
.h2{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(22px,4.5vw,36px)}
.h3{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(16px,3.6vw,22px)}
.h4{font-weight:800;font-size:clamp(14px,3.4vw,20px);color:#cfe1ff}
footer{text-align:center;color:#c9d4ec;font-family:'Cinzel',serif;font-weight:700;padding:30px 10px}
.wrap{max-width:1100px;margin:auto;padding:0 16px 80px}
.panel{padding:20px;border:1px solid var(--outline);border-radius:var(--radius);
background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));}

.card{
  position:relative;border:1px solid var(--outline);border-radius:var(--radius);
  padding:22px 16px 22px 80px;margin-bottom:10px;overflow:hidden;background:rgba(255,255,255,.04)
}

/* Sweeping yellow meter (stays behind) */
.sweep{
  position:absolute;inset:0;height:100%;width:100%;
  transform:translateX(-100%);
  background:linear-gradient(0deg,rgba(255,246,128,.92),rgba(255,246,128,.7));
  mix-blend-mode:screen;opacity:.75;border-radius:6px;
  z-index:0;pointer-events:none;will-change:transform,opacity;
}
@keyframes sweepAcross { from { transform:translateX(-100%);} to { transform:translateX(0%);} }
.sweep.run{ animation:sweepAcross var(--dur,6s) linear forwards; }

.en{
  font-weight:900;font-size:clamp(26px,7.4vw,48px);text-align:center;line-height:1.25;
  position:relative;z-index:3; /* above sweep */
}
.en .word{display:inline-block;padding:0 .06em;color:#fff;transition:color .2s ease, transform .2s ease}
.en .word.blue{color:#60a5fa;transform:translateY(-8px) scale(1.08);} /* pop above sweep */
.en .word.red{color:#ff5757}

/* Hearts */
.heart{
  position:absolute;left:0;top:0;transform:translate(-50%,0);
  font-size:22px;color:#ff7eb9;opacity:0;z-index:4;
  animation:heartUp .9s ease-out forwards;
}
@keyframes heartUp{0%{transform:translate(-50%,0) scale(1);opacity:1}
100%{transform:translate(-50%,-60px) scale(1.4);opacity:0}}

/* Gold play button (Sage only on tap) */
.playBtn{
  position:absolute;left:16px;top:50%;transform:translateY(-50%);
  width:48px;height:48px;border-radius:50%;border:none;cursor:pointer;display:grid;place-items:center;
  font-weight:900;font-size:20px;color:#351b00;z-index:3;
  background:radial-gradient(circle at 30% 30%,#ffe8a3,#ffd36a 60%,#ffb800 100%);
  box-shadow:0 0 0 3px rgba(255,213,120,.35),0 0 16px rgba(255,214,120,.45),
             inset 0 3px 6px rgba(255,255,255,.6),inset 0 -6px 14px rgba(201,112,0,.55);
  animation:goldPulse 1.8s ease-in-out infinite
}
@keyframes goldPulse{
  0%,100%{box-shadow:0 0 0 3px rgba(255,213,120,.25),0 0 10px rgba(255,214,120,.35),
           inset 0 2px 5px rgba(255,255,255,.55),inset 0 -6px 14px rgba(201,112,0,.55)}
  50%{box-shadow:0 0 0 4px rgba(255,213,120,.45),0 0 22px rgba(255,214,120,.85),
      inset 0 4px 8px rgba(255,255,255,.85),inset 0 -8px 18px rgba(201,112,0,.75)}
}

.jp{text-align:center;font-weight:700;font-size:clamp(16px,3.8vw,22px);color:#d8e7ff}
.hira{text-align:center;font-size:clamp(14px,3.4vw,18px);color:#bcd3ff;margin-top:6px}

/* Always-visible rainbow listening circle (centerpiece) */
.meterWrap{display:flex;justify-content:center;margin:22px 0}
.meter{position:relative;width:min(64vw,280px);height:min(64vw,280px);display:grid;place-items:center}
.ring{
  position:absolute;inset:0;border-radius:50%;
  background:conic-gradient(#ff7eb9,#a6f7b2,#7dd3fc,#fff680,#c77dff,#8aff80,#ff7eb9);
  -webkit-mask:radial-gradient(circle,transparent 60%,black 62%);
  mask:radial-gradient(circle,transparent 60%,black 62%);
  animation:rainbowCycle 3s linear infinite
}
@keyframes rainbowCycle{0%{filter:hue-rotate(0)}100%{filter:hue-rotate(360deg)}}
.meterCore{
  position:absolute;inset:12%;border-radius:50%;
  background:radial-gradient(circle at 50% 40%,rgba(255,255,255,.2),rgba(255,255,255,.05));
  display:grid;place-items:center;text-align:center;animation:corePulse 3s ease-in-out infinite
}
@keyframes corePulse{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}
.meterText{font-weight:900;font-size:clamp(18px,6vw,28px);line-height:1.25}

/* Rainbow shimmer for LISTENING only */
.shimmer{
  background:linear-gradient(90deg,#fff, #ffd1f3, #d1ffe3, #d1e6ff, #fff680, #ffd1f3, #fff);
  -webkit-background-clip:text;background-clip:text;color:transparent;
  background-size:300% 100%;
  animation:shimmerMove 1.2s linear infinite;
  text-shadow:0 0 18px rgba(255,255,255,.25);
}
@keyframes shimmerMove{0%{background-position:0% 0}100%{background-position:100% 0}}

.btnRow{display:flex;justify-content:center;gap:10px;margin-top:10px}
.btn{border:none;border-radius:999px;padding:14px 20px;font-weight:900;font-size:clamp(18px,4vw,22px);cursor:pointer}
.btn.begin{background:linear-gradient(180deg,#1ee99a,#0ea85d);color:#002a11}
.btn.retry{background:linear-gradient(180deg,#8ec5ff,#1e6eff);color:#00163a}
.btn.next{background:linear-gradient(180deg,#ff9ad7,#ff4fa6);color:#38001a}
.btn:disabled{opacity:.5;cursor:not-allowed}

.scoreBox{
  margin:14px auto 6px;max-width:620px;text-align:center;padding:14px 16px;border-radius:18px;
  background:rgba(255,255,255,.05);font-weight:900;font-size:clamp(18px,4.2vw,24px)
}
</style>
</head>
<body>
<header>
  <div class="h1">THE BOO-RICULUM</div>
  <div class="h2">SPEAK & REPEAT</div>
  <div class="h3">January Week 1 – Speaking Practice</div>
  <div class="h4">１月第１週 – スピーキング練習</div>
</header>

<div class="wrap">
  <div class="panel">
    <div class="card">
      <!-- sweeping meter BEHIND text -->
      <div id="sweep" class="sweep"></div>
      <!-- play button (Sage only on tap) -->
      <button id="playBtn" class="playBtn" aria-label="Play sentence audio">▶</button>
      <!-- sentence -->
      <div id="en" class="en">Press スタート to start</div>
    </div>

    <div id="jp" class="jp"></div>
    <div id="hira" class="hira"></div>

    <!-- Always-visible rainbow listening circle -->
    <div class="meterWrap">
      <div class="meter">
        <div class="ring"></div>
        <div class="meterCore"><div id="meterText" class="meterText">Ready<br><small>スタンバイ</small></div></div>
      </div>
    </div>

    <div class="btnRow">
      <button id="beginBtn" class="btn begin">スタート<br><small>Start</small></button>
      <button id="retryBtn" class="btn retry" style="display:none">もう一回<br><small>Retry</small></button>
      <button id="nextBtn" class="btn next" style="display:none">つぎへ<br><small>Next</small></button>
    </div>

    <div id="scoreBox" class="scoreBox" style="display:none"></div>
  </div>
</div>

<footer>Bryan’s English School</footer>

<script>
/* ====== QUESTIONS (all 15) ====== */
let ITEMS=[
{en:"What is your goal this year?",jp:"今年の目標は何ですか。",hira:"(ことし の もくひょう は なん です か)"},
{en:"Why is it important to you?",jp:"あなたにとってなぜ大切ですか。",hira:"(あなた に とって なぜ たいせつ です か)"},
{en:"How will you reach your goal?",jp:"どうやって目標を達成しますか。",hira:"(どうやって もくひょう を たっせい します か)"},
{en:"Who helps you stay motivated?",jp:"やる気を保つのを誰が助けてくれますか。",hira:"(やるき を たもつ の を だれ が たすけて くれ ます か)"},
{en:"What habit do you want to change?",jp:"変えたい習慣は何ですか。",hira:"(かえたい しゅうかん は なん です か)"},
{en:"Do you like making resolutions?",jp:"新年の目標を立てるのは好きですか。",hira:"(しんねん の もくひょう を たてる の は すき です か)"},
{en:"What do you want to try this year?",jp:"今年挑戦したいことは何ですか。",hira:"(ことし ちょうせん したい こと は なん です か)"},
{en:"What’s something new you learned recently?",jp:"最近新しく学んだことは何ですか。",hira:"(さいきん あたらしく まなんだ こと は なん です か)"},
{en:"Is it easy to keep goals?",jp:"目標を続けるのは簡単ですか。",hira:"(もくひょう を つづける の は かんたん です か)"},
{en:"What happens when you don’t try?",jp:"挑戦しないとどうなりますか。",hira:"(ちょうせん しない と どう なり ます か)"},
{en:"What makes you feel proud?",jp:"何があなたを誇らしくさせますか。",hira:"(なに が あなた を ほこらしく させ ます か)"},
{en:"What’s your dream for the future?",jp:"将来の夢は何ですか。",hira:"(しょうらい の ゆめ は なん です か)"},
{en:"How do you stay positive?",jp:"どうやって前向きでいられますか。",hira:"(どうやって まえむき で いられ ます か)"},
{en:"Who inspires you?",jp:"あなたに影響を与える人は誰ですか。",hira:"(あなた に えいきょう を あたえる ひと は だれ です か)"},
{en:"How can English help your goals?",jp:"英語はあなたの目標にどう役立ちますか。",hira:"(えいご は あなた の もくひょう に どう やくだち ます か)"}
];
// Shuffle each visit
ITEMS = ITEMS.sort(()=>Math.random()-0.5);

/* ----- Elements ----- */
const enEl   = document.getElementById('en');
const jpEl   = document.getElementById('jp');
const hiraEl = document.getElementById('hira');
const beginBtn = document.getElementById('beginBtn');
const retryBtn = document.getElementById('retryBtn');
const nextBtn  = document.getElementById('nextBtn');
const scoreBox = document.getElementById('scoreBox');
const meterText= document.getElementById('meterText');
const playBtn  = document.getElementById('playBtn');
const sweep    = document.getElementById('sweep');

/* ----- Score SFX (pre-warmed) ----- */
const SCORE_URLS = {
  low : "assets/audio/0-43.mp3",
  mid : "assets/audio/44-74.mp3",
  high: "assets/audio/75-99.mp3",
  max : "assets/audio/100.mp3"
};
const _preloads = Object.values(SCORE_URLS).map(u => { const a=new Audio(u); a.preload="auto"; a.load(); return a; });

/* Single SFX channel */
let sfx = new Audio();
sfx.preload = "auto";
sfx.volume = 1;
sfx.playbackRate = 0.95;
sfx.preservesPitch = true;

function playSfx(url){
  return new Promise(resolve=>{
    try{
      sfx.pause();
      sfx.src = url;
      sfx.currentTime = 0;
      const onEnd = ()=>{ sfx.removeEventListener('ended', onEnd); resolve(); };
      sfx.addEventListener('ended', onEnd, { once:true });
      const go = ()=>{ sfx.play().catch(()=>resolve()); };
      if (sfx.readyState >= 3) go();
      else sfx.addEventListener('canplaythrough', go, { once:true });
      sfx.load();
    }catch(_){ resolve(); }
  });
}
async function playScoreSound(score){
  if(score===100) return playSfx(SCORE_URLS.max);
  if(score>=75)   return playSfx(SCORE_URLS.high);
  if(score>=44)   return playSfx(SCORE_URLS.mid);
  return playSfx(SCORE_URLS.low);
}

/* ----- State ----- */
const DUR_MS = 6000; // 6s listening
let idx=0, listening=false, SR=null, streamAllowed=false;

/* ----- Helpers ----- */
function normalize(s){
  return s.toLowerCase()
          .replace(/[’‘´`]/g,"'")
          .replace(/[^a-z0-9'\s]/g,' ')
          .replace(/\s+/g,' ')
          .trim();
}
function toSet(s){ return new Set(normalize(s).split(' ').filter(Boolean)); }
function stripForFile(s){return s.toLowerCase().replace(/[^a-z0-9]/g,'');}

function playSage(en){
  if(listening) return; // block during listening
  const f = './audio/'+stripForFile(en)+'.mp3';
  const a = new Audio(f);
  a.preload = 'auto';
  a.volume = 1;
  a.playbackRate = 0.95;
  const go = ()=> a.play().catch(()=>{});
  if (a.readyState >= 3) go(); else a.addEventListener('canplaythrough', go, { once:true });
  a.load();
}

function mountWords(t){
  enEl.innerHTML = t.split(/\s+/).map(w=>`<span class="word">${w}</span>`).join(' ');
}

function clearHearts(){
  enEl.querySelectorAll('.heart').forEach(h=>h.remove());
}
function popHeartAt(el){
  const h=document.createElement('span');h.className='heart';h.textContent='❤';
  const r=el.getBoundingClientRect(),pr=enEl.getBoundingClientRect();
  h.style.left=(r.left-pr.left+r.width/2)+'px';h.style.top=(r.top-pr.top)+'px';
  enEl.appendChild(h);setTimeout(()=>h.remove(),900);
}

function markSpoken(spoken){
  const spokenSet = toSet(spoken);
  enEl.querySelectorAll('.word').forEach(w=>{
    const val = normalize(w.textContent);
    if(spokenSet.has(val) && !w.classList.contains('blue')){
      w.classList.add('blue');
      popHeartAt(w);
    }
  });
}

function finalizeColors(){
  enEl.querySelectorAll('.word').forEach(w=>{
    if(!w.classList.contains('blue')) w.classList.add('red');
  });
}

function keywordScore(target,spoken){
  const keys=toSet(target), said=toSet(spoken);
  let hit=0, total=0;
  keys.forEach(k=>{ if(k.length>2){ total++; if(said.has(k)) hit++; } });
  return total? Math.round((hit/total)*100) : 0;
}

function resetVisuals(){
  sweep.classList.remove('run');
  void sweep.offsetWidth; // reflow
  clearHearts();
  enEl.querySelectorAll('.word').forEach(w=>w.classList.remove('blue','red'));
  scoreBox.style.display='none';
}

/* ----- UI Text helpers ----- */
function setReady(){
  meterText.classList.remove('shimmer');
  meterText.innerHTML = 'Ready<br><small>スタンバイ</small>';
}
function setListening(){
  meterText.classList.add('shimmer');
  meterText.innerHTML = 'Listening<br><small>リスニング中</small>';
}
function setFinished(){
  meterText.classList.remove('shimmer');
  meterText.innerHTML = 'Finished<br><small>おわり！</small>';
}

function showItem(){
  const it=ITEMS[idx];
  mountWords(it.en);
  jpEl.textContent=it.jp;
  hiraEl.textContent=it.hira;
  resetVisuals();
  setReady();
}

/* ----- Mic permission (only on Start/Retry) ----- */
async function requestMic(){
  try{
    const s=await navigator.mediaDevices.getUserMedia({audio:true});
    s.getTracks().forEach(t=>t.stop());
    streamAllowed=true;
  }catch(e){
    alert("マイクが使えません。ブラウザの権限を確認してください。");
  }
}

/* ----- Speech Recognition setup ----- */
function makeRecognizer(){
  const R = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!R) return null;
  const r = new R();
  r.lang='en-US';
  r.continuous=true;
  r.interimResults=true;
  try{ r.maxAlternatives=5; }catch(_){}
  return r;
}

/* ----- Round flow ----- */
async function beginRound(){
  const R = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!R){ alert("このブラウザでは音声認識が使えません。Chrome を使用してください。"); return; }
  if(!streamAllowed){ await requestMic(); if(!streamAllowed) return; }

  // Start sweep (6s) and lock controls
  sweep.style.setProperty('--dur','6s');
  sweep.classList.remove('run'); void sweep.offsetWidth; sweep.classList.add('run');

  listening=true;
  playBtn.disabled=true;
  setListening();

  let heard="";

  SR = makeRecognizer();
  if(!SR){ alert("音声認識を初期化できませんでした。"); return; }

  SR.onresult = (e)=>{
    // aggregate partials quickly
    let chunk="";
    for(let i=e.resultIndex;i<e.results.length;i++){
      const alt = e.results[i][0];
      chunk += (alt && alt.transcript ? alt.transcript : "") + " ";
    }
    heard = (heard + " " + chunk).trim();
    markSpoken(heard);
  };
  SR.onend = ()=>{
    // keep it alive while listening
    if(listening){
      try{ SR.start(); }catch(_){}
    }
  };
  SR.onerror = (ev)=>{
    // keep trying on transient errors / no-speech
    if(listening){
      try{ SR.abort(); }catch(_){}
      setTimeout(()=>{ try{ SR.start(); }catch(_){} }, 120);
    }
  };

  try{ SR.start(); }catch(_){}

  // listen for fixed duration
  await new Promise(r=>setTimeout(r, DUR_MS));

  listening=false;
  setFinished();
  try{ SR.stop(); }catch(_){}

  finalizeColors();

  const s=keywordScore(ITEMS[idx].en,heard);
  scoreBox.textContent="スコア："+s+"％";
  scoreBox.style.display='block';

  await playScoreSound(s);

  nextBtn.style.display=(s>=75)?'inline-block':'none';
  retryBtn.style.display=(s<75)?'inline-block':'none';
  playBtn.disabled=false;
}

/* ----- Buttons ----- */
beginBtn.onclick=()=>{ showItem(); beginRound(); };
retryBtn.onclick =()=>{ showItem(); beginRound(); }; // reset then re-listen
nextBtn.onclick  =()=>{
  idx++;
  if(idx>=ITEMS.length){
    enEl.textContent="Great work today!";
    jpEl.textContent="よくできました！";
    hiraEl.textContent="";
    nextBtn.style.display='none';
    retryBtn.style.display='none';
    beginBtn.style.display='none';
    setReady();
    sweep.classList.remove('run');
    return;
  }
  showItem();
};
playBtn.onclick =()=> playSage(ITEMS[idx].en);

/* ----- Init (no auto-start) ----- */
showItem();
</script>
</body>
</html>
