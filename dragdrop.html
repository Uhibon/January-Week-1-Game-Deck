<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Booha Drag & Drop – January Week 1</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet">

<style>
:root{
  --dark:#0b1530;
  --ink:#ffffff;
  --green:#22c55e;
  --red:#e53935;
  --outline:#ffffffcc;
  --check:#22c55e;
  --checkGlow:0 0 12px rgba(34,197,94,.9), 0 0 28px rgba(34,197,94,.5);
  --gold:#ffd166;
  --cuteBlue:#60a5fa;
  --cuteBlueGlow:0 0 14px rgba(96,165,250,.9), 0 0 36px rgba(96,165,250,.55);
  --cardH: 140px;         /* desktop card height */
  --actionsH: 72px;       /* mobile sticky actions height */
}

/* base */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  min-height:100%;
  background:var(--dark);
  color:var(--ink);
  font-family:'Noto Sans JP',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  display:flex;flex-direction:column;align-items:center;
  overscroll-behavior-y: none;
}

/* Header + footer */
header{padding:20px 16px 10px;text-align:center}
header h1{
  font-family:'Cinzel',serif;letter-spacing:.5px;
  font-size:clamp(1.8rem,5.2vw,2.6rem);
  opacity:.95
}
header h2{
  font-family:'Cinzel',serif;letter-spacing:1px;margin-top:6px;
  font-size:clamp(2.0rem,6.2vw,3rem);
  text-shadow:0 0 10px rgba(255,255,255,.12)
}
.subtitle-stack{opacity:.85;font-size:.95rem;letter-spacing:.08em;display:flex;gap:.4rem;justify-content:center;flex-wrap:wrap}
.subtitle-stack .en::after{content:" / "; opacity:.8}
@media (max-width:700px){
  .subtitle-stack{flex-direction:column; gap:.1rem}
  .subtitle-stack .en::after{content:""}
}

footer{
  margin-top:auto;padding:14px 10px;opacity:.9;font-size:1rem;
  font-family:'Cinzel',serif;
}

/* Top-left Quit button */
.top-nav-btn{
  position:fixed;
  top:10px;
  left:10px;
  z-index:40;
  border-radius:999px;
  padding:6px 14px;
  border:1px solid #ffffff66;
  background:rgba(15,23,42,.95);
  color:#fff;
  font-size:.78rem;
  font-weight:700;
  letter-spacing:.04em;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:4px;
  box-shadow:0 0 12px rgba(0,0,0,.6);
  backdrop-filter:blur(4px);
}
.top-nav-btn span.jp{opacity:.9;font-weight:600}

/* Pages */
.page{width:100%;max-width:980px;margin:0 auto;display:none;padding:8px 16px 24px}
.page.active{display:block}

/* Round viewport + layout */
.round-viewport{ width:100%; }
.round-wrap{
  display:flex;gap:26px;align-items:flex-start;justify-content:center;flex-wrap:wrap;margin-top:16px;
}
.col{flex:1 1 420px;max-width:460px;display:flex;flex-direction:column;gap:14px}

/* ✅ Allow vertical scroll gestures anywhere; lock only during active drag */
.round-viewport,
.round-wrap,
.card,
.col { touch-action: pan-y; }
body.draggingTouch .round-wrap{ touch-action: none; }

/* MOBILE layout improvements */
@media (max-width:700px){
  :root{ --cardH: 104px; }
  #page-round.page.active{display:flex; flex-direction:column; padding-bottom:0;}
  .round-viewport{
    flex:1 1 auto;
    min-height:0;
    overflow-y:auto;
    -webkit-overflow-scrolling:touch;
    overscroll-behavior-y:contain;
    scrollbar-gutter: stable both-edges;
    padding-bottom: calc(var(--actionsH) + env(safe-area-inset-bottom) + 14px);
  }
  .round-wrap{flex-wrap:nowrap;gap:10px}
  .col{flex:0 0 50%;max-width:50%}
  .card{ padding:14px 16px; }
  .actions{
    position:sticky; bottom:0; z-index:5;
    height: var(--actionsH);
    display:flex; align-items:center; justify-content:center;
    padding: 8px 0 calc(env(safe-area-inset-bottom));
    background: linear-gradient(180deg, transparent, rgba(11,21,48,.28) 40%, rgba(11,21,48,.55));
    backdrop-filter: blur(2px);
    margin-top: 6px;
  }
}

/* Cards */
.card{
  border-radius:24px; 
  height:var(--cardH);
  padding:18px 20px;
  display:flex; align-items:center; justify-content:center; text-align:center;
  font-size:clamp(1.4rem,4.6vw,2.4rem); font-weight:700; line-height:1.2;
  user-select:none; transition:transform .15s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease, color .2s ease;
  word-break:break-word;
}
.card.en{
  color:#000; font-weight:1000;
  font-size:clamp(1.8rem,5.8vw,3rem);
  letter-spacing:-.01em;
  word-break: keep-all;
  overflow-wrap: normal;
  hyphens: none;
}
.card.jp{
  background:transparent; border:3px dashed var(--outline); color:var(--ink);
  white-space:pre-line;
}
.card.dragging{opacity:.65; transform:scale(1.04)}
.card.locked{pointer-events:none}

/* Tap-selected EN for touch mode */
.card.en.tap-selected{
  box-shadow:0 0 0 4px rgba(255,255,255,.9), 0 0 18px rgba(96,165,250,.9);
  transform:scale(1.03);
}

/* Combined before grading */
.card.combined{ border:0; display:flex; flex-direction:column; gap:8px; }
.card.matchedBlue{
  background:var(--cuteBlue)!important; 
  color:#fff!important; 
  box-shadow:var(--cuteBlueGlow)!important;
}
.card.combined .enTxt{font-size:1.05em; font-weight:1000; letter-spacing:-.01em}
.card.combined .jpTxt{font-size:.7em; opacity:.98}

/* Grading */
.card.correct{background:var(--green) !important; color:#062a12 !important; border:0 !important}
.card.wrong  {background:var(--red)   !important; color:#fff     !important; border:0 !important; animation:shake .45s}
@keyframes shake{
  0%,100%{transform:translateX(0)}
  20%{transform:translateX(-8px)}
  40%{transform:translateX(8px)}
  60%{transform:translateX(-6px)}
  80%{transform:translateX(6px)}
}

/* Buttons */
.actions{display:flex;gap:14px;justify-content:center;margin-top:18px;flex-wrap:wrap}
.btn{
  border:0; border-radius:28px; padding:12px 34px; font-weight:800; font-size:1.1rem; cursor:pointer;
  transition:transform .08s ease, box-shadow .2s ease, filter .2s ease;
  touch-action: manipulation;
}
.btn:active{transform:translateY(1px)}
.btn-green{ background:var(--check); color:#062a12; box-shadow:var(--checkGlow) }
.btn-green:disabled{filter:saturate(.2) brightness(.8); box-shadow:none; cursor:not-allowed}
.btn-secondary{
  background:rgba(15,23,42,.9);
  color:#fff;
  border:1px solid #ffffff66;
  box-shadow:0 0 12px rgba(0,0,0,.6);
  font-size:1rem;
}

/* Results */
#page-results .result-box{
  min-height:62vh; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;
}
.result-msg{font-family:'Noto Sans JP',sans-serif;font-size:clamp(2.4rem,6.4vw,3.2rem);margin-bottom:18px}
.result-score{font-size:clamp(1.8rem,5.4vw,2.4rem);opacity:.95}

/* Glow backgrounds */
.redGlow{background:#900; box-shadow:inset 0 0 60px 30px #ff2b2b}
.orangeGlow{background:#a34f00; box-shadow:inset 0 0 60px 30px #ff9e2b}
.blueGlow{background:#0d2b7a; box-shadow:inset 0 0 60px 30px #2b7bff}
.goldGlow{background:#725c00; box-shadow:inset 0 0 80px 40px #ffd166}

/* Perfect-run confetti */
.confetti{
  position:fixed; width:12px; height:12px; border-radius:50%;
  top:-12px; left:0;
  animation:fall 1.2s linear forwards;
  pointer-events:none; z-index:10;
}
@keyframes fall{
  0%{transform:translateY(0) rotate(0)}
  100%{transform:translateY(110vh) rotate(720deg)}
}

/* Per-card effects */
.bit{
  position:fixed; width:14px; height:14px; border-radius:3px;
  pointer-events:none; z-index:20; animation:pop 760ms ease-out forwards;
}
@keyframes pop{
  0%{opacity:1; transform:translate(0,0) scale(1) rotate(0deg)}
  100%{opacity:0; transform:translate(var(--dx),var(--dy)) scale(0.9) rotate(540deg)}
}
.poof{
  position:fixed; width:40px; height:40px; border-radius:50%;
  background:radial-gradient(closest-side, rgba(74,222,128,.97) 0%, rgba(34,197,94,.7) 55%, rgba(34,197,94,0) 70%);
  filter:blur(2px);
  pointer-events:none; z-index:19;
  animation:puff 950ms.ease-out forwards;
}
@keyframes puff{
  0%{opacity:.98; transform:translate(-50%,-50%) scale(.7)}
  100%{opacity:0; transform:translate(-50%,-50%) scale(7)}
}

/* English vertical stripes */
@keyframes stripesV{ from{background-position:0 0} to{background-position:0 var(--cardH)} }
.sv{ background-size:100% var(--cardH); animation:stripesV 3.2s linear infinite; }
.sv1{ background-image:repeating-linear-gradient(0deg, #ff7eb9 0 18px, #5ee6ff 18px 36px, #ffd166 36px 54px); }
.sv2{ background-image:repeating-linear-gradient(0deg, #a78bfa 0 18px, #60a5fa 18px 36px, #f472b6 36px 54px); }
.sv3{ background-image:repeating-linear-gradient(0deg, #34d399 0 18px, #fbbf24 18px 36px, #60a5fa 36px 54px); }
.sv4{ background-image:repeating-linear-gradient(0deg, #fca5a5 0 18px, #86efac 18px 36px, #93c5fd 36px 54px); }
.sv5{ background-image:repeating-linear-gradient(0deg, #f9a8d4 0 18px, #fef08a 18px 36px, #6ee7b7 36px 54px); }

/* Drag ghost (desktop pointer-drag) */
.drag-ghost{
  position:fixed; z-index:9999; pointer-events:none;
  transform:translate(-50%,-50%); will-change:transform;
  width:46vw; max-width:420px;
  height:var(--cardH);
  display:flex; align-items:center; justify-content:center;
  border-radius:24px; font-weight:1000; color:#000;
}
@media (min-width: 701px){
  .drag-ghost{ width:360px; }
}
.hoverTarget{ box-shadow:0 0 0 4px rgba(255,255,255,.25), 0 0 20px rgba(255,255,255,.25); border-color:#fff !important; }

hr.sep{border:0;height:1px;background:linear-gradient(90deg,transparent,#ffffff33,transparent);margin:12px 0 8px}

/* Help icon bottom-left */
.help-icon{
  position:fixed;
  left:14px;
  bottom:calc(14px + env(safe-area-inset-bottom));
  width:34px;
  height:34px;
  border-radius:999px;
  border:none;
  background:var(--cuteBlue);
  box-shadow:var(--cuteBlueGlow);
  color:#05101f;
  font-weight:900;
  font-size:1.2rem;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:35;
}

/* Help overlay */
.help-overlay{
  position:fixed;
  inset:0;
  background:radial-gradient(circle at top, rgba(96,165,250,.42), transparent 55%),
             radial-gradient(circle at bottom, rgba(34,197,94,.35), transparent 55%),
             rgba(2,6,23,.88);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:50;
}
.help-overlay.show{display:flex;}
.help-dialog{
  max-width:520px;
  width:90%;
  padding:20px 20px 18px;
  border-radius:24px;
  background:rgba(15,23,42,.96);
  border:1px solid #ffffff55;
  box-shadow:0 0 30px rgba(0,0,0,.8);
  position:relative;
}
.help-title{
  font-family:'Cinzel',serif;
  font-size:1.35rem;
  margin-bottom:8px;
  text-align:center;
}
.help-sub{
  font-size:.9rem;
  opacity:.8;
  text-align:center;
  margin-bottom:10px;
}
.help-content{
  font-size:.92rem;
  line-height:1.6;
}
.help-content ul{
  padding-left:1.1em;
  margin:4px 0 10px;
}
.help-content li{
  margin-bottom:4px;
}
.help-close{
  position:absolute;
  top:8px;
  right:10px;
  border:none;
  border-radius:999px;
  width:26px;
  height:26px;
  background:rgba(30,64,175,.9);
  color:#fff;
  font-weight:900;
  cursor:pointer;
  font-size:1rem;
}

/* small helper label under title */
.help-label{
  font-size:.78rem;
  opacity:.72;
  text-align:center;
  margin-bottom:10px;
}
</style>
</head>
<body>

<!-- Quit button (top-left) -->
<button id="quitBtn" class="top-nav-btn">
  <span>Quit</span><span class="jp">／ やめる</span>
</button>

<header>
  <h1>THE BOO-RICULUM</h1>
  <h2>GAMES &amp; QUIZZES</h2>
  <div class="subtitle-stack">
    <div class="en">January Week 1 - Vocabulary</div>
    <div class="jp">１月第１週 - 語彙</div>
  </div>
  <hr class="sep">
</header>

<!-- PAGE: Round container -->
<section id="page-round" class="page active">
  <div class="round-viewport">
    <div class="round-wrap" id="dragArea">
      <div id="col-en" class="col"></div>
      <div id="col-jp" class="col"></div>
    </div>
  </div>
  <div class="actions">
    <button id="checkBtn" class="btn btn-green" disabled>CHECK</button>
  </div>
</section>

<!-- PAGE: Results -->
<section id="page-results" class="page">
  <div class="result-box">
    <div id="resultMsg" class="result-msg">結果</div>
    <div id="resultScore" class="result-score">0/15 (0%)</div>
  </div>
  <div class="actions">
    <button id="playAgain" class="btn btn-green">もう一度 ／ Play Again</button>
    <button id="backToMenu" class="btn btn-secondary">メインメニューへ ／ Main Menu</button>
  </div>
</section>

<footer>Bryan's English School</footer>

<!-- Help icon -->
<button id="helpBtn" class="help-icon">?</button>

<!-- Help overlay -->
<div id="helpOverlay" class="help-overlay">
  <div class="help-dialog">
    <button id="helpClose" class="help-close">×</button>
    <div class="help-title">How to Play ／ 遊び方</div>
    <div class="help-sub">Booha Drag &amp; Drop Game</div>
    <div class="help-content">
      <p><strong>English</strong></p>
      <ul>
        <li>On phones and tablets: <strong>tap an English card</strong>, then tap the matching <strong>Japanese card</strong>.</li>
        <li>On computers: <strong>drag each English card</strong> on the left onto the matching <strong>Japanese card</strong> on the right.</li>
        <li>When all 5 pairs are connected, tap <strong>CHECK</strong>.</li>
        <li>Correct answers turn <strong>green</strong> with a “ding” sound.</li>
        <li>Wrong answers turn <strong>red</strong> with a funny “boo” sound.</li>
        <li>There are <strong>3 rounds</strong> (15 questions total). Try for a perfect score!</li>
      </ul>

      <hr class="sep" style="margin:8px 0;">

      <p><strong>日本語</strong></p>
      <ul>
        <li>スマホ・タブレットでは、まず<strong>左の英語カードをタップ</strong>し、そのあと<strong>意味が同じ日本語カードをタップ</strong>します。</li>
        <li>パソコンでは、左の<strong>英語カードをドラッグして</strong>右の<strong>日本語カードの上に重ねます</strong>。</li>
        <li>5つすべてペアにできたら、<strong>CHECK（チェック）</strong>ボタンを押します。</li>
        <li>正解は<strong>緑色</strong>になり、「ピン！」という音が鳴ります。</li>
        <li>まちがいは<strong>赤色</strong>になり、面白い「ブー」の音が鳴ります。</li>
        <li><strong>3ラウンド（合計15問）</strong>あります。パーフェクトを目指してね！</li>
      </ul>
    </div>
  </div>
</div>

<!-- Audio -->
<audio id="s_ding" src="assets/audio/ding.mp3" preload="auto"></audio>
<audio id="s_fart" src="assets/audio/fart.mp3" preload="auto"></audio>
<audio id="s_r05" src="assets/audio/result_0-5.mp3" preload="auto"></audio>
<audio id="s_r610" src="assets/audio/result_6-10.mp3" preload="auto"></audio>
<audio id="s_r1114" src="assets/audio/result_11-14.mp3" preload="auto"></audio>
<audio id="s_r15" src="assets/audio/result_15.mp3" preload="auto"></audio>

<script>
/* DATA */
const MASTER = [
  {en:"goal",jp:"目標",hira:"もくひょう"},
  {en:"plan",jp:"計画",hira:"けいかく"},
  {en:"future",jp:"未来",hira:"みらい"},
  {en:"dream",jp:"夢",hira:"ゆめ"},
  {en:"challenge",jp:"挑戦",hira:"ちょうせん"},
  {en:"try",jp:"挑戦する",hira:"ちょうせん する"},
  {en:"change",jp:"変える",hira:"かえる"},
  {en:"habit",jp:"習慣",hira:"しゅうかん"},
  {en:"exercise",jp:"運動",hira:"うんどう"},
  {en:"study",jp:"勉強",hira:"べんきょう"},
  {en:"learn",jp:"学ぶ",hira:"まなぶ"},
  {en:"practice",jp:"練習",hira:"れんしゅう"},
  {en:"success",jp:"成功",hira:"せいこう"},
  {en:"focus",jp:"集中",hira:"しゅうちゅう"},
  {en:"motivation",jp:"やる気",hira:"やるき"}
];

/* State */
let rounds=[], roundIndex=0, totalScore=0, connections={}, jpOrder=[], audioUnlocked=false;
let selectedEnCard = null;

/* Device mode */
const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

/* Helpers */
const $ = s=>document.querySelector(s);
function playSfx(id){
  const src=document.getElementById(id); if(!src) return;
  const a=src.cloneNode(true); a.setAttribute('playsinline',''); a.currentTime=0; a.volume=src.volume??1;
  document.body.appendChild(a); a.play().catch(()=>{}).finally(()=>setTimeout(()=>a.remove(),1800));
}
function centerOf(el){const r=el.getBoundingClientRect();return{ x:r.left+r.width/2, y:r.top+r.height/2 };}

/* Shuffle */
function shuffle(a){return a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(x=>x[1]);}

/* Effects */
function burstConfettiAt(el,count=44){
  const {x,y}=centerOf(el);
  for(let i=0;i<count;i++){
    const b=document.createElement('div'); b.className='bit';
    b.style.left=x+'px'; b.style.top=y+'px';
    const ang=Math.random()*2*Math.PI, dist=80+Math.random()*130;
    b.style.setProperty('--dx', Math.cos(ang)*dist+'px');
    b.style.setProperty('--dy', Math.sin(ang)*dist-10+'px');
    b.style.background=`hsl(${Math.random()*360},100%,60%)`;
    document.body.appendChild(b); setTimeout(()=>b.remove(),820);
  }
}
function fartPoofAt(el){
  const {x,y}=centerOf(el);
  const p=document.createElement('div'); p.className='poof';
  p.style.left=x+'px'; p.style.top=y+'px';
  document.body.appendChild(p); setTimeout(()=>p.remove(),980);
}

/* Mobile audio unlock */
function unlockAudioOnce(){
  if(audioUnlocked) return;
  ["s_ding","s_fart","s_r05","s_r610","s_r1114","s_r15"].forEach(id=>{
    const el=document.getElementById(id);
    try{ el.volume=1.0; el.currentTime=0; el.play().then(()=>el.pause()).catch(()=>{});}catch(e){}
  });
  audioUnlocked=true;
}
window.addEventListener('pointerdown', unlockAudioOnce, {once:true});

/* iOS pull-to-refresh guard */
function installPullToRefreshGuard(){
  const scroller = document.querySelector('.round-viewport');
  if(!scroller) return;

  let startY=0;

  scroller.addEventListener('touchstart', (e)=>{
    if(e.touches.length!==1) return;
    startY = e.touches[0].clientY;
  }, {passive:true});

  scroller.addEventListener('touchmove', (e)=>{
    if(e.touches.length!==1) return;
    const y  = e.touches[0].clientY;
    const dy = y - startY;

    const atTop    = scroller.scrollTop <= 0;
    const atBottom = scroller.scrollTop + scroller.clientHeight >= scroller.scrollHeight - 1;

    if ((atTop && dy > 0) || (atBottom && dy < 0)) {
      e.preventDefault();
    }
  }, {passive:false});
}

/* Init */
function initGame(){
  totalScore=0; roundIndex=0; document.body.className='';
  $("#page-results").classList.remove('active'); $("#page-round").classList.add('active');
  const shuffled=shuffle([...MASTER]);
  rounds=[shuffled.slice(0,5),shuffled.slice(5,10),shuffled.slice(10,15)];
  loadRound();
}

/* Combine helper */
function combineIntoJP(jpCard, enText){
  if(!jpCard || !jpCard.dataset) return;

  if(jpCard.dataset.connected){
    const old=document.querySelector(`.en[data-en="${jpCard.dataset.connected}"]`);
    if(old) old.style.visibility='visible';
  }
  const enCard=document.querySelector(`.en[data-en="${enText}"]`);
  if(enCard) enCard.style.visibility='hidden';

  const jp = jpCard.dataset.jp, hira = jpCard.dataset.hira;
  jpCard.classList.add('combined','matchedBlue'); jpCard.classList.remove('jp');
  jpCard.innerHTML = `<div class="enTxt">${enText}</div><div class="jpTxt">${jp}（${hira}）</div>`;
  jpCard.dataset.connected = enText;
  connections[jp] = enText;

  $("#checkBtn").disabled = Object.keys(connections).length !== 5;
}

/* Build a round */
function loadRound(){
  connections={};
  selectedEnCard = null;
  const set=rounds[roundIndex], colEn=$("#col-en"), colJp=$("#col-jp");
  colEn.innerHTML=""; colJp.innerHTML="";

  const stripeClasses=shuffle(['sv1','sv2','sv3','sv4','sv5']);

  shuffle([...set]).forEach((item,idx)=>{
    const c=document.createElement('div');
    c.className=`card en sv ${stripeClasses[idx % stripeClasses.length]}`;
    c.draggable=true;
    c.textContent=item.en.toLowerCase();
    c.dataset.en=item.en.toLowerCase();
    c.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/en',c.dataset.en); c.classList.add('dragging');});
    c.addEventListener('dragend',()=>c.classList.remove('dragging'));
    colEn.appendChild(c);
  });

  shuffle([...set]).forEach(item=>{
    const c=document.createElement('div');
    c.className='card jp';
    c.dataset.jp=item.jp; c.dataset.hira=item.hira; c.dataset.connected="";
    c.textContent=`${item.jp}\n(${item.hira})`;
    c.addEventListener('dragover', e=>e.preventDefault());
    c.addEventListener('drop', e=>{
      e.preventDefault();
      const en=e.dataTransfer.getData('text/en'); if(!en) return;
      combineIntoJP(c, en);
    });
    colJp.appendChild(c);
  });

  if(isTouch){
    setupTapMode();
  }else{
    setupPointerDrag();
  }

  jpOrder=[...colJp.querySelectorAll('[data-jp]')];
  $("#checkBtn").disabled=true;
}

/* Tap mode (touch devices): tap EN → tap JP */
function setupTapMode(){
  selectedEnCard = null;
  const enCards = [...document.querySelectorAll('.card.en')];
  const jpCards = [...document.querySelectorAll('[data-jp]')];

  enCards.forEach(c=>{
    c.addEventListener('click', ()=>{
      if(c.style.visibility === 'hidden') return;

      if(selectedEnCard === c){
        c.classList.remove('tap-selected');
        selectedEnCard = null;
        return;
      }
      if(selectedEnCard){
        selectedEnCard.classList.remove('tap-selected');
      }
      selectedEnCard = c;
      c.classList.add('tap-selected');
    });
  });

  jpCards.forEach(jpCard=>{
    jpCard.addEventListener('click', ()=>{
      if(!selectedEnCard) return;
      const enText = selectedEnCard.dataset.en;
      combineIntoJP(jpCard, enText);
      selectedEnCard.classList.remove('tap-selected');
      selectedEnCard = null;
    });
  });
}

/* Pointer drag (desktop / non-touch) */
function setupPointerDrag(){
  const enCards = [...document.querySelectorAll('.card.en')];

  let ghost=null, active=null, hoverJP=null;
  let startX=0, startY=0, dragging=false;
  let pressTimer=null;

  const LONG_PRESS_MS = 220;
  const MOVE_THRESH  = 12;

  function makeGhost(fromCard){
    const g = fromCard.cloneNode(true);
    g.className = g.className.replace(/\bcard\b/,'').trim();
    g.classList.add('drag-ghost');
    const cs = getComputedStyle(fromCard);
    g.style.backgroundImage  = cs.backgroundImage;
    g.style.backgroundSize   = cs.backgroundSize;
    g.style.backgroundPosition = cs.backgroundPosition;
    document.body.appendChild(g);
    return g;
  }

  function beginDrag(e){
    if (dragging || !active) return;
    dragging = true;
    try{ active.setPointerCapture(e.pointerId); }catch(_){}
    document.body.classList.add('draggingTouch');
    ghost = makeGhost(active);
    moveGhost(e);
  }

  function pointerDown(e){
    if(e.pointerType === 'mouse'){
      return; // standard HTML5 drag already works for mouse
    }
    if(e.pointerType !== 'touch' && e.pointerType !== 'pen') return;
    active = e.currentTarget;
    startX = e.clientX; startY = e.clientY;
    dragging = false;

    clearTimeout(pressTimer);
    pressTimer = setTimeout(()=> beginDrag(e), LONG_PRESS_MS);
  }

  function pointerMove(e){
    if(!active) return;

    const dx = Math.abs(e.clientX - startX);
    const dy = Math.abs(e.clientY - startY);

    if (!dragging && (dy > dx + 8 || dx + dy > MOVE_THRESH)) {
      clearTimeout(pressTimer);
    }
    if (!dragging && (dx > dy + 10) && (dx + dy > MOVE_THRESH)) {
      beginDrag(e);
    }

    if (dragging){
      moveGhost(e);
      e.preventDefault();
    }
  }

  function moveGhost(e){
    if(!ghost) return;
    ghost.style.left = e.clientX + 'px';
    ghost.style.top  = e.clientY + 'px';
    const el = document.elementFromPoint(e.clientX, e.clientY);
    const cand = el && el.closest && el.closest('[data-jp]');
    if(cand !== hoverJP){
      if(hoverJP) hoverJP.classList.remove('hoverTarget');
      hoverJP = cand;
      if(hoverJP) hoverJP.classList.add('hoverTarget');
    }
  }

  function endDrag(e){
    clearTimeout(pressTimer);
    if(!active) return;

    if(dragging){
      if(hoverJP) hoverJP.classList.remove('hoverTarget');
      if(ghost){
        const el = document.elementFromPoint(e.clientX, e.clientY);
        const target = el && el.closest && el.closest('[data-jp]');
        if(target){ combineIntoJP(target, active.dataset.en); }
        ghost.remove(); ghost = null;
      }
      document.body.classList.remove('draggingTouch');
    }

    try{ active.releasePointerCapture && active.releasePointerCapture(e.pointerId); }catch(_){}
    active=null; hoverJP=null; dragging=false;
  }

  enCards.forEach(c=>{
    c.addEventListener('pointerdown', pointerDown, {passive:true});
  });
  window.addEventListener('pointermove',  pointerMove, {passive:false});
  window.addEventListener('pointerup',    endDrag,     {passive:true});
  window.addEventListener('pointercancel',endDrag,     {passive:true});
}

/* Check flow */
$("#checkBtn").addEventListener('click',()=>{
  $("#checkBtn").disabled=true;
  let i=0;
  const step=setInterval(()=>{
    if(i>=jpOrder.length){
      clearInterval(step);
      setTimeout(()=>{
        roundIndex++;
        if(roundIndex<3){ loadRound(); } else { showResults(); }
      },900);
      return;
    }
    const card=jpOrder[i], jp=card.dataset.jp;
    const chosen=card.dataset.connected||"";
    const correct = rounds.flat().find(v=>v.jp===jp)?.en.toLowerCase();

    card.classList.remove('matchedBlue');

    if(chosen && chosen===correct){
      card.classList.remove('wrong');
      card.classList.add('correct','locked');
      playSfx('s_ding');
      burstConfettiAt(card,44);
      totalScore++;
    }else{
      card.classList.remove('correct');
      card.classList.add('wrong');
      playSfx('s_fart');
      fartPoofAt(card);
    }
    i++;
  },850);
});

/* Results */
function showResults(){
  $("#page-round").classList.remove('active');
  $("#page-results").classList.add('active');

  const pct=Math.round((totalScore/15)*100);
  const msgEl=$("#resultMsg"), scoreEl=$("#resultScore");

  let bg='blueGlow', msg='いいね！あと少しでパーフェクト！', snd=$("#s_r1114");
  if(totalScore<=5){ bg='redGlow'; msg='ブーリキュラム見てないでしょ！'; snd=$("#s_r05"); }
  else if(totalScore<=10){ bg='orangeGlow'; msg='YouTube見すぎ！ブーリキュラムもやろう！'; snd=$("#s_r610"); }
  else if(totalScore===15){ bg='goldGlow'; msg='すごい！あなたは地球で一番頭がいい！'; snd=$("#s_r15"); }

  document.body.className=bg;
  msgEl.textContent=msg;
  scoreEl.textContent=`${totalScore}/15（${pct}%）`;

  try{ snd.currentTime=0; snd.play(); }catch(e){}

  if(totalScore===15){
    for(let i=0;i<160;i++){
      setTimeout(()=>{
        const c=document.createElement('div');
        c.className='confetti';
        c.style.left=(Math.random()*100)+'vw';
        c.style.background=`hsl(${Math.random()*360},100%,60%)`;
        c.style.animationDuration=(0.9+Math.random()*0.9)+'s';
        document.body.appendChild(c);
        setTimeout(()=>c.remove(),1900);
      }, i*10);
    }
  }
}

/* Buttons */
$("#playAgain").addEventListener('click', initGame);

$("#backToMenu").addEventListener('click', () => {
  window.location.href = "index.html";
});

$("#quitBtn").addEventListener('click', () => {
  window.location.href = "index.html";
});

/* Help overlay logic */
const helpOverlay = $("#helpOverlay");
const helpBtn = $("#helpBtn");
const helpClose = $("#helpClose");

function closeHelp(){
  helpOverlay.classList.remove('show');
}

helpBtn.addEventListener('click', () => {
  helpOverlay.classList.add('show');
});

helpClose.addEventListener('click', closeHelp);

helpOverlay.addEventListener('click', (e) => {
  if(e.target === helpOverlay){
    closeHelp();
  }
});

/* Start */
installPullToRefreshGuard();
initGame();
</script>
</body>
</html>
