<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Booha Speak & Listen – January Week 1</title>
<meta name="theme-color" content="#0b1530" />
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet" />
<style>
:root{
  --bg:#0b1530;--ink:#fff;--gold1:#fdd86d;--gold2:#ffb347;
  --blueGlow:0 0 10px #60a5fa,0 0 20px #3b82f6;
  --pinkGlow:0 0 10px #f472b6,0 0 20px #ec4899;
  --purpleGlow:0 0 10px #c084fc,0 0 20px #a855f7;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--ink);
  min-height:100vh;display:flex;flex-direction:column;align-items:center;overflow:hidden;}
header{text-align:center;padding:1rem;font-family:'Cinzel',serif;}
header h1{font-size:1.6rem;text-shadow:0 0 10px rgba(255,255,255,.5);}
header h2{color:var(--gold1);text-shadow:0 0 10px var(--gold2);}
main{flex:1;display:flex;flex-direction:column;align-items:center;width:100%;max-width:700px;padding:0 1rem;text-align:center;}

.playBtn,.micBtn{
  width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  cursor:pointer;color:#000;font-weight:900;font-size:1.4rem;z-index:5;
}
.playBtn{background:linear-gradient(135deg,var(--gold1),var(--gold2));box-shadow:0 0 15px var(--gold2);}
.micBtn{background:linear-gradient(135deg,#a855f7,#7e22ce);box-shadow:var(--purpleGlow);position:absolute;right:-18px;top:50%;transform:translateY(-50%);}

#sageBox{width:100%;min-height:100px;margin-top:1rem;border-radius:24px;
  background:repeating-linear-gradient(45deg,#ffd6ff,#caffbf,#9bf6ff,#a0c4ff,#ffadad);
  font-size:1.4rem;font-weight:900;display:flex;align-items:center;justify-content:center;text-align:center;padding:1rem;}
#options{width:100%;margin-top:1rem;}
.option{border:2px solid #ffffff30;border-radius:20px;padding:1rem;margin:.4rem 0;background:#ffffff10;
  color:#fff;font-size:1.2rem;cursor:pointer;transition:.2s;}
.option.played{opacity:.5;filter:grayscale(1);}
#studentBox{width:100%;min-height:80px;margin-top:1rem;background:#fff;color:#000;border-radius:20px;
  display:flex;align-items:center;justify-content:center;transition:.3s;position:relative;}
#studentBox.active{box-shadow:0 0 15px #22c55e;background:#e8ffe8;}
#studentBox.inactive{border:3px solid #ef4444;}
.buttonsRow{display:flex;gap:.6rem;justify-content:center;margin-top:1rem;}
button{padding:.7rem 2rem;border:none;border-radius:20px;font-weight:900;font-family:'Cinzel',serif;cursor:pointer;}
#pointsBtn{background:linear-gradient(135deg,#3b82f6,#60a5fa);box-shadow:var(--blueGlow);}
#nextBtn{background:linear-gradient(135deg,#f472b6,#ec4899);box-shadow:var(--pinkGlow);}
#counter{margin-top:.8rem;}
#pointsCircle{position:fixed;bottom:1rem;right:1rem;width:70px;height:70px;border-radius:50%;
  background:linear-gradient(135deg,var(--gold1),var(--gold2));color:#000;display:flex;align-items:center;justify-content:center;
  font-weight:900;font-family:'Cinzel',serif;box-shadow:0 0 15px var(--gold2);}
footer{text-align:center;color:#fff;padding:1rem 0;font-family:'Cinzel',serif;}
</style>
</head>
<body>
<header>
  <h1>THE BOO-RICULUM</h1>
  <h2>Eigo Adventure – January Week 1</h2>
</header>

<div id="pointsCircle">0</div>

<main>
  <div id="sageBox"><div id="sageText"></div></div>
  <div id="options"></div>

  <div id="studentBox" class="inactive">
    <div class="micBtn" id="micBtn"></div>
  </div>

  <div class="buttonsRow">
    <button id="pointsBtn">Points モード</button>
    <button id="nextBtn">次へ ▶</button>
  </div>
  <div id="counter">1 / 3</div>
</main>

<footer>Bryan’s English School</footer>

<script>
const PRAISE=['audio/yes_good_job.mp3','audio/perfect_english.mp3','audio/wow_nice_work.mp3'];
const TRY_AGAIN=['audio/hmm_try_again.mp3','audio/what_language_was_that.mp3','audio/do_you_have_a_cookie_in_your_mouth.mp3'];
const POINT_SOUND='assets/audio/eigo.mp3';

const questions=[
 {q:\"What do you eat for breakfast?\",a:0,audio:\"audio/what_do_you_eat_for_breakfast.mp3\",answers:[\"I eat rice and miso soup for breakfast.\",\"I eat curry for breakfast.\",\"I eat toothpaste for breakfast.\",\"I eat pencils and notebooks for breakfast.\"]},
 {q:\"What do you do after school?\",a:0,audio:\"audio/what_do_you_do_after_school.mp3\",answers:[\"I do my homework after school.\",\"I climb trees after school.\",\"I build a spaceship after school.\",\"I wrestle with ghosts after school.\"]},
 {q:\"What do you do after dinner?\",a:0,audio:\"audio/what_do_you_do_after_dinner.mp3\",answers:[\"I help my parents clean the table after dinner.\",\"I juggle spaghetti after dinner.\",\"I play soccer in the kitchen after dinner.\",\"I sleep under the table after dinner.\"]}
];

let current=0,points=0,recog,listening=false,pointsMode=false,spokenSet=new Set();
const $=s=>document.querySelector(s);
const sageText=$("#sageText"),studentBox=$("#studentBox"),micBtn=$("#micBtn"),
      nextBtn=$("#nextBtn"),pointsBtn=$("#pointsBtn"),pointsCircle=$("#pointsCircle"),counter=$("#counter"),optionsBox=$("#options");

function normalize(s){return s.toLowerCase().replace(/[’‘´`]/g,\"'\").replace(/[^a-z0-9'\\s]/g,' ').replace(/\\s+/g,' ').trim();}
function pulsePoints(){pointsCircle.style.transform='scale(1.3)';setTimeout(()=>pointsCircle.style.transform='scale(1)',300);}
function updateUI(){pointsCircle.textContent=points;counter.textContent=(current+1)+' / '+questions.length;}
function audioPlay(p){return new Promise(r=>{const a=new Audio(p);a.onended=r;a.onerror=r;a.play().catch(r);});}
async function ensureMicPermissionOnce(){try{await navigator.mediaDevices.getUserMedia({audio:true});}catch(e){}}

function initRecog(){const R=window.SpeechRecognition||window.webkitSpeechRecognition;if(!R)return;recog=new R();recog.lang='en-US';recog.interimResults=true;
  recog.onstart=()=>{listening=true;studentBox.classList.add('active');studentBox.classList.remove('inactive');studentBox.textContent='';};
  recog.onend=()=>{listening=false;studentBox.classList.remove('active');studentBox.classList.add('inactive');if(pointsMode)startMic();};
  recog.onresult=e=>{const t=Array.from(e.results).map(r=>r[0].transcript).join(' ');studentBox.textContent=t;checkSpeech(t);};}
function startMic(){if(!recog)initRecog();if(recog&&!listening){try{recog.start();}catch{}}}

async function playQuestion(){
  await ensureMicPermissionOnce();
  const q=questions[current];
  sageText.textContent=q.q;
  await audioPlay(q.audio);
  startMic();
}

function renderAnswers(){
  optionsBox.innerHTML='';
  spokenSet.clear();
  const q=questions[current];
  q.answers.forEach(a=>{
    const div=document.createElement('div');
    div.className='option';
    div.textContent=a;
    optionsBox.appendChild(div);
  });
}

async function checkSpeech(spoken){
  const q=questions[current];
  const nsp=normalize(spoken);

  if(pointsMode){
    for(const d of [...optionsBox.children]){
      const text=d.textContent;
      if(spokenSet.has(text)) continue;
      if(nsp===normalize(text)){
        spokenSet.add(text);
        await audioPlay('audio/yes_good_job.mp3');
        await audioPlay(POINT_SOUND);
        d.remove();
        points+=1;pulsePoints();updateUI();
        return;
      }
    }
    await audioPlay('audio/hmm_try_again.mp3');
    return;
  }

  let m=-1;
  for(let i=0;i<q.answers.length;i++){
    if(nsp===normalize(q.answers[i])){m=i;break;}
  }
  if(m===q.a){
    await audioPlay('audio/yes_good_job.mp3');
    await audioPlay(POINT_SOUND);
    points+=5;pulsePoints();updateUI();
  } else if(m!==-1){
    await audioPlay('audio/hmm_try_again.mp3');
  }
}

function loadQuestion(){
  sageText.textContent=questions[current].q;
  studentBox.textContent='';
  renderAnswers();
  updateUI();
}

micBtn.onclick=()=>{if(!recog)initRecog();if(listening){try{recog.stop();}catch{}}else startMic();};
nextBtn.onclick=()=>{try{if(listening)recog.stop();}catch{}current++;if(current>=questions.length)current=0;loadQuestion();};
pointsBtn.onclick=()=>{pointsMode=!pointsMode;pointsBtn.style.opacity=pointsMode?0.6:1;if(pointsMode)startMic();};

loadQuestion();
</script>
</body>
</html>
