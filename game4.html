<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Booha Game 4 – Eigo Adventure!</title>
<meta name="theme-color" content="#000000" />
<link rel="icon" type="image/png" href="booha-ghost.png">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&display=swap" rel="stylesheet" />
<style>
:root{
  --ink:#ffffff; --muted:#cfd3dc; --bg:#0b1530; --radius:28px;
  --accent:#ff7eb9; --accent2:#5ee6ff; --gold:#ffd166; --good:#22c55e; --bad:#ef4444;
}

/* Reset */
*{box-sizing:border-box;margin:0;padding:0}

/* Page */
html,body{height:100%;background:#000;color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Inter,sans-serif;}

/* Spiral + glow background */
body::before{
  content:""; position:fixed; inset:0;
  background:radial-gradient(1200px 1200px at 50% 40%, #1c2a55 0%, #0b1530 40%, #000 100%);
  z-index:-2;
}
body::after{
  content:""; position:fixed; left:50%; top:45%; width:190vmax; height:190vmax;
  transform:translate(-50%,-50%) rotate(0deg);
  border-radius:50%;
  background:conic-gradient(from 0deg,
    rgba(255,255,255,.35) 0 20deg, rgba(255,255,255,0) 20 40deg,
    rgba(255,255,255,.35) 40 60deg, rgba(255,255,255,0) 60 80deg,
    rgba(255,255,255,.35) 80 100deg, rgba(255,255,255,0) 100 120deg,
    rgba(255,255,255,.35) 120 140deg, rgba(255,255,255,0) 140 160deg,
    rgba(255,255,255,.35) 160 180deg, rgba(255,255,255,0) 180 200deg,
    rgba(255,255,255,.35) 200 220deg, rgba(255,255,255,0) 220 240deg,
    rgba(255,255,255,.35) 240 260deg, rgba(255,255,255,0) 260 280deg,
    rgba(255,255,255,.35) 280 300deg, rgba(255,255,255,0) 300 320deg,
    rgba(255,255,255,.35) 320 340deg, rgba(255,255,255,0) 340 360deg);
  mix-blend-mode:overlay; opacity:.5; filter:hue-rotate(190deg);
  animation:spin 18s linear infinite;
  z-index:-1;
}
@keyframes spin{ to{ transform:translate(-50%,-50%) rotate(360deg);} }

/* Header */
header{
  padding:18px 16px 8px; text-align:center; font-family:'Cinzel',serif;
}
header h1{ font-size:clamp(28px,4.8vw,48px); letter-spacing:1px; font-weight:900;}
header h2{ font-size:clamp(16px,2.8vw,22px); color:var(--muted); margin-top:4px; font-weight:700;}

/* Card */
.card{
  width:min(1000px,92vw);
  margin:20px auto;
  background:linear-gradient(160deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  border:2px solid rgba(255,255,255,.15);
  border-radius:var(--radius);
  box-shadow:0 30px 80px rgba(0,0,0,.45);
  overflow:hidden;
}

/* Top bar */
.top{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:14px 18px; background:rgba(255,255,255,.04);
  border-bottom:1px solid rgba(255,255,255,.12);
}
.badge{
  font-family:'Cinzel',serif; font-weight:800;
  background:linear-gradient(90deg,#ff7eb9,#5ee6ff);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  letter-spacing:.5px;
}
.progress{
  display:flex; align-items:center; gap:10px; color:var(--muted); font-weight:600;
}
.progress .dot{
  width:10px;height:10px;border-radius:50%; background:#334; box-shadow:0 0 6px rgba(255,255,255,.25) inset;
}
.progress .dot.active{ background:#7dd3fc; }
.score{
  font-weight:800; color:#a6f7b2;
}

/* Paragraph area */
.content{
  padding:20px clamp(14px,4vw,28px) 8px;
}
h3#paraTitle{
  font-family:'Cinzel',serif; font-weight:900;
  font-size:clamp(18px,3.6vw,26px);
  margin-bottom:14px; letter-spacing:.5px;
}
.sentence{
  font-size:clamp(18px,2.6vw,24px);
  line-height:1.55;
  padding:10px 0;
}
.blank{
  display:inline-flex; align-items:center; justify-content:center;
  min-width:120px; padding:2px 10px; margin:0 4px;
  border-bottom:3px dashed rgba(255,255,255,.45);
  color:#fff; font-weight:800; letter-spacing:.5px;
  background:linear-gradient(180deg, rgba(255,255,255,.06), transparent);
  border-radius:10px;
}
.blank.waiting{ box-shadow:0 0 0 4px rgba(255,255,255,.08) inset; }
.blank.correct{
  background:linear-gradient(90deg,#fff680,#a6f7b2);
  color:#111; border-bottom-color:transparent; box-shadow:0 0 25px rgba(255,246,128,.55);
  animation:pop .35s ease;
}
@keyframes pop{ 0%{transform:scale(.9)} 100%{transform:scale(1)} }

/* JP/Hira hint row */
.hint{
  margin:8px 0 4px; color:var(--muted); font-size:clamp(13px,2.2vw,16px);
  display:flex; gap:14px; flex-wrap:wrap;
}

/* Controls */
.controls{
  display:flex; flex-wrap:wrap; gap:10px; padding:16px 18px 22px; justify-content:center;
  border-top:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.03);
}
button{
  appearance:none; border:0; padding:12px 16px; border-radius:14px;
  font-weight:800; letter-spacing:.3px; cursor:pointer;
  color:#111; background:linear-gradient(90deg,#ff7eb9,#5ee6ff);
  box-shadow:0 12px 30px rgba(0,0,0,.35);
}
button.secondary{ color:#eee; background:#223047; }
button.good{ background:linear-gradient(90deg,#a6f7b2,#fff680); color:#111; }
button.bad{ background:#ef4444; color:#fff; }
button:disabled{ filter:grayscale(.5) brightness(.8); cursor:not-allowed; }

/* Mic indicator */
.mic{
  display:flex; align-items:center; gap:10px; color:var(--muted); font-weight:700;
}
.micDot{
  width:12px;height:12px;border-radius:50%; background:#334;
  box-shadow:0 0 0 0 rgba(94,230,255,.6);
}
.mic.listening .micDot{ background:#5ee6ff; animation:ping 1.5s infinite; }
@keyframes ping{
  0%{ box-shadow:0 0 0 0 rgba(94,230,255,.6); }
  70%{ box-shadow:0 0 0 14px rgba(94,230,255,0); }
  100%{ box-shadow:0 0 0 0 rgba(94,230,255,0); }
}

/* Footer */
footer{
  text-align:center; color:#9aa3b2; padding:16px 0 28px; font-size:14px;
}

/* Result overlay */
#result{
  position:fixed; inset:0; background:rgba(0,0,0,.75);
  display:none; align-items:center; justify-content:center; z-index:9;
}
.resultCard{
  width:min(680px,92vw); background:#0e1a3a; border:2px solid rgba(255,255,255,.15);
  border-radius:24px; padding:24px; text-align:center;
  box-shadow:0 30px 100px rgba(0,0,0,.7);
}
.resultCard h2{ font-family:'Cinzel',serif; font-weight:900; font-size:clamp(26px,4.5vw,42px); margin-bottom:6px;}
.resultCard p{ color:#cfd3dc; margin-bottom:16px; }
.bigScore{ font-size:clamp(26px,6vw,56px); font-weight:900; color:#a6f7b2; margin:10px 0 20px; }

/* Confetti (simple) */
.confetti{
  position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:10;
}
.confetti i{
  position:absolute; width:8px; height:14px; top:-20px; opacity:.9;
  background:linear-gradient(180deg,#fff680,#ff7eb9);
  transform:rotate(10deg);
  animation:fetti 3.2s linear forwards;
}
@keyframes fetti{
  to{ transform:translateY(110vh) rotate(360deg); opacity:1;}
}
</style>
</head>
<body>

<header>
  <h1>The Boo-riculum</h1>
  <h2>ゲーム４：Eigo Adventure!（英語アドベンチャー）</h2>
</header>

<main class="card" id="app">
  <div class="top">
    <div class="badge">January – Goals & New Beginnings</div>
    <div class="progress">
      <div id="dots"></div>
      <div class="score" id="scoreLabel">Score: 0%</div>
    </div>
  </div>

  <div class="content">
    <h3 id="paraTitle">Paragraph 1 / 10</h3>
    <div id="sentences"></div>
    <div class="hint" id="hintRow"></div>
  </div>

  <div class="controls">
    <button id="btnPlay">▶️ Play sentence</button>
    <button class="secondary" id="btnRepeat">↻ Repeat</button>
    <button class="secondary" id="btnReveal">👀 Reveal word</button>
    <button class="good" id="btnNext" disabled>Next →</button>
    <div class="mic" id="mic">
      <div class="micDot"></div> <span id="micText">Mic: ready</span>
    </div>
  </div>
</main>

<div id="result">
  <div class="resultCard">
    <h2>Adventure Complete!</h2>
    <p>Great listening, reading, and speaking.</p>
    <div class="bigScore" id="finalScore">ペラペラレベル 0%</div>
    <button onclick="location.href='index.html'" class="good">← Back to Game Deck</button>
  </div>
  <div class="confetti" id="confetti"></div>
</div>

<footer>
  Bryan's English School
</footer>

<script>
/* ---------------------------
   DATA: 10 paragraphs × 5
----------------------------*/
const PARAGRAPHS = [
  { // 1 – Fresh Start
    en: [
      "It’s January, and I _____ start something new.",
      "Every morning, I write my _____ in my notebook.",
      "I _____ a little, even on weekends.",
      "I _____ because this year feels different.",
      "I will _____ to make every day special."
    ],
    answers: ["will","goals","study","smile","try"],
    jp: ["１月です。新しいことを始めます。","毎朝、ノートに目標を書きます。","週末でも少し勉強します。","今年は違う気がして笑います。","毎日を特別にするために挑戦します。"]
  },
  { // 2 – The Plan
    en: [
      "I will wake up _____ and eat breakfast.",
      "I’m going to _____ before school.",
      "I will not be _____ anymore.",
      "I will _____ carefully in class.",
      "I will _____ my classmates when they need me."
    ],
    answers: ["early","read","late","listen","help"],
    jp: ["早起きして朝ごはんを食べます。","学校の前に読みます。","もう遅刻しません。","授業でしっかり聞きます。","クラスメイトを手伝います。"]
  },
  { // 3 – At School
    en: [
      "My teacher says, “Do your _____!”",
      "I will _____ my desk today.",
      "I will _____ more English in class.",
      "I will _____ new words in my notebook.",
      "I will _____ learning every subject."
    ],
    answers: ["best","clean","speak","write","enjoy"],
    jp: ["先生は「ベストを尽くして」と言います。","今日は机を片づけます。","授業で英語をもっと話します。","ノートに新しい単語を書きます。","すべての教科の学びを楽しみます。"]
  },
  { // 4 – Making Friends
    en: [
      "I will _____ a new friend this week.",
      "We will _____ about our favorite games.",
      "We will _____ home together.",
      "We will _____ at funny stories.",
      "Friendship makes school _____."
    ],
    answers: ["make","talk","walk","laugh","fun"],
    jp: ["今週、新しい友だちを作ります。","好きなゲームについて話します。","一緒に歩いて帰ります。","おもしろい話に笑います。","友情は学校を楽しくします。"]
  },
  { // 5 – Good Habits
    en: [
      "I will _____ a good habit this month.",
      "I will _____ more books.",
      "I will _____ English every day.",
      "I will _____ yesterday’s lesson.",
      "I will _____ until it feels easy."
    ],
    answers: ["start","read","practice","review","continue"],
    jp: ["今月は良い習慣を始めます。","もっと本を読みます。","毎日英語を練習します。","昨日のレッスンを復習します。","簡単になるまで続けます。"]
  },
  { // 6 – Challenges
    en: [
      "Sometimes I will _____ my goal.",
      "Sometimes I will feel _____.",
      "I will _____ again and again.",
      "I will _____ on small steps.",
      "I will never _____ up."
    ],
    answers: ["forget","tired","try","focus","give"],
    jp: ["ときどき目標を忘れてしまいます。","疲れることもあります。","何度も挑戦します。","小さな一歩に集中します。","決してあきらめません。"]
  },
  { // 7 – At Home
    en: [
      "After school, I will _____ my room.",
      "I will _____ my family with dinner.",
      "I will _____ before playing games.",
      "I will _____ my parents my homework.",
      "I will _____ them for helping me."
    ],
    answers: ["clean","help","study","show","thank"],
    jp: ["放課後、部屋を掃除します。","夕食を家族と手伝います。","ゲームの前に勉強します。","宿題を両親に見せます。","手伝ってくれたことに感謝します。"]
  },
  { // 8 – Free Time
    en: [
      "On weekends, I will _____ pictures.",
      "I will _____ to music in English.",
      "I will _____ a movie with subtitles.",
      "I will _____ new words from songs.",
      "I will _____ and feel proud."
    ],
    answers: ["draw","listen","watch","learn","relax"],
    jp: ["週末は絵を描きます。","英語の音楽を聴きます。","字幕付きの映画を見ます。","歌から新しい単語を学びます。","リラックスして誇らしく思います。"]
  },
  { // 9 – Reflection
    en: [
      "I think about my _____ every week.",
      "I will _____ what I learned.",
      "I will _____ my ideas with my teacher.",
      "I will _____ small successes.",
      "I will _____ to keep going."
    ],
    answers: ["progress","remember","share","celebrate","promise"],
    jp: ["毎週、自分の進歩について考えます。","学んだことを覚えておきます。","先生と自分の考えを共有します。","小さな成功を祝います。","続けることを約束します。"]
  },
  { // 10 – The Goal
    en: [
      "This year, I will _____ in many ways.",
      "I will _____ in myself.",
      "I will _____ big and stay kind.",
      "I will _____ English with confidence.",
      "I will _____ like a Booha star."
    ],
    answers: ["grow","believe","dream","speak","shine"],
    jp: ["今年、いろいろな面で成長します。","自分を信じます。","大きな夢を持ち、親切にします。","自信を持って英語を話します。","ブーハの星のように輝きます。"]
  }
];

let currentPara = 0;
let currentSent = 0;
let score = 0;
let totalBlanks = PARAGRAPHS.reduce((a,p)=>a+p.answers.length,0);

const elSentences = document.getElementById('sentences');
const elParaTitle = document.getElementById('paraTitle');
const elDots = document.getElementById('dots');
const elScore = document.getElementById('scoreLabel');
const elMic = document.getElementById('mic');
const elMicText = document.getElementById('micText');
const elHint = document.getElementById('hintRow');

const btnPlay = document.getElementById('btnPlay');
const btnRepeat = document.getElementById('btnRepeat');
const btnReveal = document.getElementById('btnReveal');
const btnNext = document.getElementById('btnNext');

function speak(text){
  // If you have local Sage audio per sentence, play it here.
  // Fallback: Web Speech API TTS (offline-ish).
  if ('speechSynthesis' in window){
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'en-US'; u.rate = 0.95; u.pitch = 1;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }
}

// Build top dots
function buildDots(){
  elDots.innerHTML='';
  for (let i=0;i<PARAGRAPHS.length;i++){
    const d=document.createElement('div');
    d.className='dot'+(i===currentPara?' active':'');
    elDots.appendChild(d);
  }
}
function updateScore(){
  const pct = Math.round((score/totalBlanks)*100);
  elScore.textContent = `Score: ${pct}%`;
}

function renderParagraph(){
  const p = PARAGRAPHS[currentPara];
  elParaTitle.textContent = `Paragraph ${currentPara+1} / ${PARAGRAPHS.length}`;
  elSentences.innerHTML='';
  elHint.innerHTML='';
  currentSent = 0;

  // sentences + blanks
  p.en.forEach((line,idx)=>{
    const s = document.createElement('div');
    s.className='sentence';
    const parts = line.split('_____');
    const spanBefore = document.createElement('span');
    spanBefore.textContent = parts[0] || '';
    const blank = document.createElement('span');
    blank.className='blank';
    blank.dataset.idx = idx;
    blank.textContent = '__________';
    const spanAfter = document.createElement('span');
    spanAfter.textContent = parts[1] || '';
    s.append(spanBefore, blank, spanAfter);
    elSentences.appendChild(s);
  });

  // JP hints
  p.jp.forEach((j)=> {
    const x = document.createElement('div');
    x.textContent = j;
    elHint.appendChild(x);
  });

  buildDots();
  updateActiveBlank();
  updateScore();
  btnNext.disabled = true;
}

function activeBlankEl(){
  return elSentences.querySelector(`.blank[data-idx="${currentSent}"]`);
}
function updateActiveBlank(){
  elSentences.querySelectorAll('.blank').forEach(b=>b.classList.remove('waiting'));
  const b = activeBlankEl();
  if (b) b.classList.add('waiting');
}

function playCurrentSentencePrefix(){
  const p = PARAGRAPHS[currentPara];
  const line = p.en[currentSent];
  const [prefix] = line.split('_____');
  speak(prefix.trim());
}

function revealWord(){
  const p = PARAGRAPHS[currentPara];
  const ans = p.answers[currentSent];
  const b = activeBlankEl();
  if (!b) return;
  b.textContent = ans;
  b.classList.add('correct');
  b.classList.remove('waiting');
  score++; updateScore();
  nextWordOrParagraph();
}

function nextWordOrParagraph(){
  const p = PARAGRAPHS[currentPara];
  currentSent++;
  if (currentSent >= p.en.length){
    // Paragraph complete
    btnNext.disabled = false;
    // auto-focus next button for flow
    btnNext.focus();
    stopListening();
  }else{
    updateActiveBlank();
    // auto-play prefix for the next blank to keep flow
    setTimeout(()=> playCurrentSentencePrefix(), 450);
  }
}

function nextParagraph(){
  currentPara++;
  if (currentPara >= PARAGRAPHS.length){
    finish();
  }else{
    renderParagraph();
    listen(); // re-arm mic
  }
}

/* ---------------------------
   Speech Recognition
----------------------------*/
let recog, canListen=false;
function initRecog(){
  const R = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!R){
    elMicText.textContent = 'Mic: unavailable';
    return;
  }
  recog = new R();
  recog.lang = 'en-US';
  recog.interimResults = true;
  recog.continuous = true;

  recog.onstart = ()=>{ elMic.classList.add('listening'); elMicText.textContent='Listening…'; };
  recog.onend   = ()=>{ elMic.classList.remove('listening'); elMicText.textContent= canListen?'Listening paused':'Mic: ready'; if (canListen) recog.start(); };
  recog.onerror = ()=>{ elMic.classList.remove('listening'); elMicText.textContent='Mic error'; };

  recog.onresult = (e)=>{
    const p = PARAGRAPHS[currentPara];
    const target = p.answers[currentSent]?.toLowerCase();
    if (!target) return;
    let said = '';
    for (let i = e.resultIndex; i < e.results.length; i++){
      said += e.results[i][0].transcript + ' ';
    }
    said = said.toLowerCase();

    // Accept close matches (simple check: contains target or very close)
    const ok = said.includes(target) || closeEnough(said, target);
    if (ok){
      const b = activeBlankEl();
      if (b){
        b.textContent = p.answers[currentSent];
        b.classList.add('correct');
        b.classList.remove('waiting');
        score++; updateScore();
        // Small delay so they see success flash
        setTimeout(()=> nextWordOrParagraph(), 250);
      }
    }
  };
  canListen = true;
}

function closeEnough(input, target){
  // Basic Levenshtein threshold for short words (1 edit for <=5 chars, 2 edits otherwise)
  const dist = levenshtein(input.trim().split(/\s+/).pop()||'', target);
  if (target.length <= 5) return dist <= 1;
  return dist <= 2;
}

function levenshtein(a,b){
  const m = [];
  for (let i=0;i<=a.length;i++){ m[i]=[i]; }
  for (let j=1;j<=b.length;j++){ m[0][j]=j; }
  for (let i=1;i<=a.length;i++){
    for (let j=1;j<=b.length;j++){
      const cost = a[i-1] === b[j-1] ? 0 : 1;
      m[i][j] = Math.min(
        m[i-1][j] + 1,
        m[i][j-1] + 1,
        m[i-1][j-1] + cost
      );
    }
  }
  return m[a.length][b.length];
}

function listen(){
  if (recog && canListen){
    try{ recog.start(); }catch(e){}
  }
}
function stopListening(){
  if (recog){
    canListen=false;
    try{ recog.stop(); }catch(e){}
  }
}

/* ---------------------------
   Result / Confetti
----------------------------*/
function finish(){
  stopListening();
  const overlay = document.getElementById('result');
  const final = document.getElementById('finalScore');
  const pct = Math.round((score/totalBlanks)*100);
  final.textContent = `ペラペラレベル ${pct}%`;
  overlay.style.display='flex';
  if (pct >= 85) launchConfetti(120);
  else if (pct >= 60) launchConfetti(60);
  else launchConfetti(30);
}
function launchConfetti(n=100){
  const c = document.getElementById('confetti');
  c.innerHTML='';
  const colors = ['#fff680','#ff7eb9','#5ee6ff','#a6f7b2','#c77dff'];
  for (let i=0;i<n;i++){
    const piece = document.createElement('i');
    piece.style.left = Math.random()*100 + 'vw';
    piece.style.background = `linear-gradient(180deg, ${colors[i%colors.length]}, #fff)`;
    piece.style.animationDelay = (Math.random()*0.8)+'s';
    piece.style.transform = `rotate(${(Math.random()*40-20)}deg)`;
    c.appendChild(piece);
  }
}

/* ---------------------------
   Buttons
----------------------------*/
btnPlay.addEventListener('click', ()=> playCurrentSentencePrefix());
btnRepeat.addEventListener('click', ()=> playCurrentSentencePrefix());
btnReveal.addEventListener('click', revealWord);
btnNext.addEventListener('click', ()=>{ btnNext.disabled=true; nextParagraph(); });

/* ---------------------------
   Init
----------------------------*/
renderParagraph();
initRecog();
listen();
updateScore();
</script>

</body>
</html>
