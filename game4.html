<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Booha Speak & Listen – January Week 1</title>
<meta name="theme-color" content="#0b1530" />
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet" />
<style>
:root{
 --bg:#0b1530;--ink:#fff;--gold1:#fdd86d;--gold2:#ffb347;--outline:#ffffff26;--radius:26px;
 --goldGlow:0 0 8px #facc15,0 0 20px #fde68a;--purpleGlow:0 0 20px #c084fc,0 0 40px #c084fc;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--ink);font-family:'Noto Sans JP',sans-serif;min-height:100vh;display:flex;flex-direction:column;align-items:center;overflow:hidden;}
header{text-align:center;padding:26px 12px 12px}
.h1{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(34px,6.2vw,56px);}
.h2{font-family:'Cinzel',serif;font-weight:900;font-size:clamp(22px,4.5vw,36px);color:#fdd86d;text-shadow:var(--goldGlow);}
main{flex:1;display:flex;flex-direction:column;align-items:center;width:100%;max-width:700px;text-align:center;padding:0 1rem;}
.sageWrapper{position:relative;width:100%;margin-top:1rem;}
#sageBox,#studentBox{width:100%;min-height:100px;border:1px solid var(--outline);border-radius:var(--radius);overflow:hidden;position:relative;margin-bottom:1rem;display:flex;align-items:center;justify-content:center;text-align:center;box-shadow:0 6px 24px rgba(0,0,0,.4);background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));}
#sageBox::before{content:'';position:absolute;inset:0;z-index:0;animation:stripeSlide 18s linear infinite;background:repeating-linear-gradient(to bottom,#ff6ec7 0 28px,#5ee6ff 28px 56px,#ffd166 56px 84px,#8aff80 84px 112px,#c77dff 112px 140px,#fff680 140px 168px);background-size:100% 600px;}
@keyframes stripeSlide{from{background-position-y:0}to{background-position-y:-600px}}
#sageText{position:relative;z-index:1;font-weight:900;font-size:clamp(1.4rem,5vw,2rem);color:#0b1530;text-shadow:0 1px 0 rgba(255,255,255,.6);padding:0 1rem;}
.word{opacity:0;margin:0 .4rem;transition:opacity .25s ease;}
.playBtn{position:absolute;left:-18px;top:50%;transform:translateY(-50%);width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--gold1),var(--gold2));box-shadow:0 0 12px rgba(255,255,255,.5),0 0 24px rgba(255,255,255,.3);display:flex;align-items:center;justify-content:center;cursor:pointer;animation:shimmer 2s infinite;z-index:10;}
.playBtn::after{content:"▶";color:#000;font-size:1.4rem;font-weight:900;}
@keyframes shimmer{0%,100%{box-shadow:0 0 10px #fff,0 0 20px #fff;}50%{box-shadow:0 0 20px #ffe27a,0 0 40px #ffd700;}}
.studentWrapper{position:relative;width:100%;}
#studentBox{color:#000;font-size:1.3rem;background:#fff;transition:box-shadow .3s,background .3s;}
#studentBox.glow{box-shadow:var(--purpleGlow);}
#studentBox.shake{animation:shake .3s;}
@keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-5px);}75%{transform:translateX(5px);}}
.micBtn{position:absolute;right:-18px;top:50%;transform:translateY(-50%);width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#b388ff,#9d4edd);display:flex;align-items:center;justify-content:center;cursor:pointer;}
.micBtn::after{content:"🎤";font-size:1.3rem;}
#options .option{border:2px solid var(--outline);border-radius:var(--radius);padding:1rem;margin:0.5rem 0;width:100%;font-size:clamp(1.1rem,4vw,1.4rem);font-weight:700;background:#00000020;color:#fff;cursor:pointer;transition:opacity .2s,background .3s;}
#hintBox{margin-top:.8rem;font-size:1rem;color:#fdd86d;text-shadow:var(--goldGlow);line-height:1.4;}
#hintBox small{display:block;color:#ffe27a;margin-top:4px;}
.btnRow{display:flex;gap:1rem;justify-content:center;margin-top:1rem;flex-direction:column;align-items:center;}
.nextBtn,.pointsBtn{padding:.7rem 1.8rem;border-radius:var(--radius);color:#000;font-weight:900;font-family:'Cinzel',serif;font-size:1.1rem;border:none;cursor:pointer;display:none;}
.pointsBtn{background:linear-gradient(135deg,#93c5fd,#3b82f6);animation:blueShimmer 2s infinite;}
.nextBtn{background:linear-gradient(135deg,#f9a8d4,#ec4899);animation:pinkShimmer 2s infinite;}
@keyframes blueShimmer{0%,100%{box-shadow:0 0 10px #93c5fd,0 0 20px #3b82f6;}50%{box-shadow:0 0 20px #60a5fa,0 0 40px #2563eb;}}
@keyframes pinkShimmer{0%,100%{box-shadow:0 0 10px #f9a8d4,0 0 20px #ec4899;}50%{box-shadow:0 0 20px #f472b6,0 0 40px #db2777;}}
#pointsContainer{display:flex;flex-direction:column;align-items:center;margin-top:0.8rem;}
#pointsCircle{width:90px;height:90px;border-radius:50%;background:linear-gradient(135deg,var(--gold1),var(--gold2));display:flex;align-items:center;justify-content:center;color:#000;font-family:'Cinzel',serif;font-size:2rem;font-weight:900;box-shadow:var(--goldGlow);position:relative;overflow:hidden;text-shadow:0 0 10px #fff,0 0 20px #fff;}
#pointsCircle::after{content:'';position:absolute;width:140%;height:140%;background:radial-gradient(circle at 50% 50%,rgba(255,255,255,0.6) 0%,rgba(255,255,255,0) 70%);animation:pulse 2.5s infinite ease-in-out;}
@keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.3);opacity:0.6;}}
#scoreLabel{margin-top:8px;font-family:'Cinzel',serif;font-size:1rem;color:#fdd86d;text-shadow:var(--goldGlow);animation:goldShimmer 2s infinite;}
@keyframes goldShimmer{0%,100%{text-shadow:0 0 8px #facc15,0 0 20px #fde68a;}50%{text-shadow:0 0 14px #ffef9f,0 0 30px #fde68a;}}
#counter{margin-top:4px;font-family:'Cinzel',serif;color:#fff;font-size:1rem;text-shadow:0 0 6px rgba(255,255,255,.4);}
footer{text-align:center;color:#fff;padding:16px 0 22px;font-family:'Cinzel',serif;font-weight:900;font-size:clamp(14px,2.8vw,20px);}
</style>
</head>
<body>
<header>
 <div class="h1">THE BOO-RICULUM</div>
 <div class="h2">Eigo Adventure – January Week 1</div>
</header>

<main>
 <div class="sageWrapper">
  <div class="playBtn" id="playBtn"></div>
  <div id="sageBox"><div id="sageText"></div></div>
 </div>
 <div class="studentWrapper">
  <div id="studentBox"></div>
  <div class="micBtn" id="micBtn"></div>
 </div>
 <div id="options"></div>
 <div id="hintBox"></div>

 <div class="btnRow">
  <button class="pointsBtn" id="pointsBtn">Points</button>
  <div id="pointsContainer">
    <div id="pointsCircle">0</div>
    <div id="scoreLabel">SCORE</div>
    <div id="counter">1 / 2</div>
  </div>
  <button class="nextBtn" id="nextBtn">Next ▶</button>
 </div>
</main>

<footer>Bryan’s English School</footer>

<script>
const DING="assets/audio/ding.mp3";
const EIGO="assets/audio/eigo.mp3";
const PRAISE=['yesgoodjob.mp3','perfectenglish.mp3','wownicework.mp3'];
const TRY_AGAIN=['hmmtryagain.mp3','whatlanguagewasthat.mp3','doyouhaveacookieinyourmouth.mp3'];
const EXTRA_PRAISE=['nicework.mp3','goodtry.mp3','keepgoing.mp3'];

const questions=[
 {q:"What do you eat for breakfast?",a:0,audio:"whatdoyoueatforbreakfast.mp3",answers:[
  "I eat rice and miso soup for breakfast.",
  "I eat curry for breakfast.",
  "I eat toothpaste for breakfast.",
  "I eat pencils and notebooks for breakfast."
 ]},
 {q:"What do you do after school?",a:0,audio:"whatdoyoudoafterschool.mp3",answers:[
  "I do my homework after school.",
  "I climb trees after school.",
  "I build a spaceship after school.",
  "I wrestle with ghosts after school."
 ]}
];

let current=0,points=0,listening=false,gotCorrect=false,pointsMode=false;
let recog,remainingIncorrect=new Set();

const $=s=>document.querySelector(s);
const sageText=$('#sageText'),studentBox=$('#studentBox'),
playBtn=$('#playBtn'),micBtn=$('#micBtn'),optionsBox=$('#options'),
hintBox=$('#hintBox'),nextBtn=$('#nextBtn'),pointsBtn=$('#pointsBtn'),
pointsCircle=$('#pointsCircle'),counter=$('#counter');

function playAudio(f){return new Promise(r=>{const a=new Audio(f.includes('/')?f:'audio/'+f);a.onended=r;a.onerror=r;a.play().catch(r);});}
function pulsePoints(){pointsCircle.style.transform='scale(1.3)';setTimeout(()=>pointsCircle.style.transform='scale(1)',300);}
function updateUI(){pointsCircle.textContent=points;counter.textContent=(current+1)+' / '+questions.length;}
function animateWords(t){sageText.innerHTML='';t.split(' ').forEach((w,i)=>{const s=document.createElement('span');s.className='word';s.textContent=w;sageText.appendChild(s);setTimeout(()=>s.style.opacity=1,180*i);});}
function normalize(s){return s.toLowerCase().replace(/[’‘´`]/g,"'").replace(/[^a-z0-9'\s]/g,' ').replace(/\s+/g,' ').trim();}
function confetti(n=80){for(let i=0;i<n;i++){const c=document.createElement('div');c.style.cssText=`position:fixed;width:10px;height:10px;left:${Math.random()*100}%;top:-10px;background:hsl(${Math.random()*360},100%,70%);opacity:.9;pointer-events:none;`;document.body.appendChild(c);const d=900+Math.random()*1200;c.animate([{transform:'translateY(0)'},{transform:'translateY(100vh) rotate(720deg)'}],{duration:d,easing:'ease-out'});setTimeout(()=>c.remove(),d);}}
async function shakeRedErase(){studentBox.classList.add('shake');studentBox.style.background='#ef4444';await playAudio('audio/'+TRY_AGAIN[Math.floor(Math.random()*TRY_AGAIN.length)]);setTimeout(()=>{studentBox.classList.remove('shake');studentBox.style.background='#fff';studentBox.textContent='';},650);}

function strictMatch(spoken,answer){
 const s=normalize(spoken),a=normalize(answer);
 if(!s||!a)return false;
 const sArr=s.split(' '),aArr=a.split(' ');
 const overlap=aArr.filter(w=>sArr.includes(w)).length;
 const extra=sArr.filter(w=>!aArr.includes(w));
 return overlap/aArr.length>=0.9 && extra.length<=2;
}

function initRecog(){
 const R=window.SpeechRecognition||window.webkitSpeechRecognition;
 if(!R){alert('Speech Recognition not supported');return;}
 recog=new R();recog.lang='en-US';recog.interimResults=true;
 recog.onstart=()=>{studentBox.classList.add('glow');listening=true;};
 recog.onend=()=>{studentBox.classList.remove('glow');listening=false;};
 recog.onresult=e=>{let t='';for(const r of e.results){t+=r[0].transcript+' ';if(r.isFinal)checkSpeech(t.trim());}studentBox.textContent=t.trim();};
}
function startMic(){if(!recog)initRecog();if(!listening)try{recog.start();}catch{}}

async function playQuestion(){const q=questions[current];animateWords(q.q);await playAudio('audio/'+q.audio);startMic();}

function renderAnswers(){
  optionsBox.innerHTML='';
  const q=questions[current];
  q.answers.forEach((a,i)=>{
    const d=document.createElement('div');
    d.className='option';
    d.dataset.index=i;
    d.textContent=a;
    optionsBox.appendChild(d);
  });
}

async function checkSpeech(spoken){
 const q=questions[current];let idx=-1;
 for(let i=0;i<q.answers.length;i++){if(strictMatch(spoken,q.answers[i])){idx=i;break;}}
 if(idx===-1){await shakeRedErase();return;}
 const optEl=document.querySelector(`.option[data-index="${idx}"]`);

 // ✅ First correct = +5 points
 if(!pointsMode && idx===q.a && !gotCorrect){
   gotCorrect=true;
   await playAudio('audio/'+PRAISE[Math.floor(Math.random()*PRAISE.length)]);
   confetti(60);
   await playAudio(DING);
   points+=5;
   pulsePoints();
   updateUI();
   optEl?.remove();
   remainingIncorrect=new Set(q.answers.map((_,i)=>i).filter(i=>i!==q.a));
   pointsMode=true;
   pointsBtn.style.display='inline-block';
   hintBox.innerHTML='Points mode – say the other 3 sentences!<small>ポイントモードです。のこり３つのぶんをいってみよう！</small>';
   return;
 }

 if(!pointsMode){await shakeRedErase();return;}

 // ✅ Other sentences = +1 point each
 if(pointsMode){
   if(remainingIncorrect.has(idx)){
     remainingIncorrect.delete(idx);
     await playAudio('audio/'+EXTRA_PRAISE[Math.floor(Math.random()*EXTRA_PRAISE.length)]);
     confetti(90);
     await playAudio(EIGO);
     points+=1;
     pulsePoints();
     updateUI();
     optEl?.remove();
     if(remainingIncorrect.size===0){
       pointsBtn.style.display='none';
       nextBtn.style.display='inline-block';
       hintBox.textContent='Great job! Tap Next.';
     }
   } else {await shakeRedErase();}
 }
 studentBox.textContent='';
}

function loadQuestion(){
 gotCorrect=false;
 pointsMode=false;
 remainingIncorrect.clear?.();
 pointsBtn.style.display='none';
 nextBtn.style.display='none';
 hintBox.textContent='';
 sageText.textContent='';
 studentBox.textContent='';
 renderAnswers();
 updateUI();
}

playBtn.onclick=()=>playQuestion();
micBtn.onclick=()=>{if(!recog)initRecog();if(listening)recog.stop();else startMic();};
nextBtn.onclick=()=>{current++;if(current>=questions.length)current=0;loadQuestion();};

window.onload=loadQuestion;
</script>
</body>
</html>
