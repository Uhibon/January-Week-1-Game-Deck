<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Booha Eigo Adventure â€“ January Week 1</title>
<meta name="theme-color" content="#0b1530" />
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet" />
<style>
:root{
 --bg:#0b1530;--ink:#fff;--gold1:#fdd86d;--gold2:#ffb347;--outline:#ffffff26;--radius:26px;
 --goldGlow:0 0 8px #facc15,0 0 20px #fde68a;--purpleGlow:0 0 20px #c084fc,0 0 40px #c084fc;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  background:var(--bg);
  color:var(--ink);
  font-family:'Noto Sans JP',sans-serif;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  overflow:hidden;
}
header{text-align:center;padding:26px 12px 12px}
.h1{
  font-family:'Cinzel',serif;
  font-weight:900;
  font-size:clamp(34px,6.2vw,56px);
}
.h2{
  font-family:'Cinzel',serif;
  font-weight:900;
  font-size:clamp(22px,4.5vw,36px);
}
.h3{
  font-family:'Cinzel',serif;
  font-weight:900;
  font-size:clamp(16px,3.6vw,22px);
}
.h4{
  font-weight:800;
  font-size:clamp(14px,3.4vw,20px);
  color:#cfe1ff;
}

main{flex:1;display:flex;flex-direction:column;align-items:center;width:100%;max-width:700px;text-align:center;padding:0 1rem;}
.sageWrapper{position:relative;width:100%;margin-top:1rem;}
#sageBox,#studentBox{
  width:100%;
  min-height:100px;
  border:1px solid var(--outline);
  border-radius:var(--radius);
  overflow:hidden;
  position:relative;
  margin-bottom:1rem;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  box-shadow:0 6px 24px rgba(0,0,0,.4);
  background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
}
#sageBox::before{
  content:'';
  position:absolute;
  inset:0;
  z-index:0;
  animation:stripeSlide 18s linear infinite;
  background:repeating-linear-gradient(
    to bottom,
    #ff6ec7 0 28px,
    #5ee6ff 28px 56px,
    #ffd166 56px 84px,
    #8aff80 84px 112px,
    #c77dff 112px 140px,
    #fff680 140px 168px
  );
  background-size:100% 600px;
}
@keyframes stripeSlide{from{background-position-y:0}to{background-position-y:-600px}}
#sageText{
  position:relative;
  z-index:1;
  font-weight:900;
  font-size:clamp(1.4rem,5vw,2rem);
  color:#0b1530;
  text-shadow:0 1px 0 rgba(255,255,255,.6);
  padding:0 1rem;
}
.word{opacity:0;margin:0 .4rem;transition:opacity .25s ease;}

.playBtn{
  position:absolute;
  left:-18px;
  top:50%;
  transform:translateY(-50%);
  width:60px;
  height:60px;
  border-radius:50%;
  background:linear-gradient(135deg,var(--gold1),var(--gold2));
  box-shadow:0 0 12px rgba(255,255,255,.5),0 0 24px rgba(255,255,255,.3);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  animation:shimmer 2s infinite;
  z-index:10;
}
.playBtn::after{content:"â–¶";color:#000;font-size:1.4rem;font-weight:900;}
@keyframes shimmer{
  0%,100%{box-shadow:0 0 10px #fff,0 0 20px #fff;}
  50%{box-shadow:0 0 20px #ffe27a,0 0 40px #ffd700;}
}

.studentWrapper{position:relative;width:100%;}
#studentBox{
  color:#000;
  font-size:1.3rem;
  background:#fff;
  transition:box-shadow .3s,background .3s;
}
#studentBox.glow{box-shadow:var(--purpleGlow);}
#studentBox.shake{animation:shake .3s;}
@keyframes shake{
  0%,100%{transform:translateX(0);}
  25%{transform:translateX(-5px);}
  75%{transform:translateX(5px);}
}

.micBtn{
  position:absolute;
  right:-18px;
  top:50%;
  transform:translateY(-50%);
  width:48px;
  height:48px;
  border-radius:50%;
  background:linear-gradient(135deg,#b388ff,#9d4edd);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  animation:micPulse 2s infinite ease-in-out;
}
.micBtn::after{content:"ğŸ¤";font-size:1.3rem;}
@keyframes micPulse{
  0%,100%{box-shadow:0 0 10px #b388ff,0 0 20px #b388ff;transform:scale(1);}
  50%{box-shadow:0 0 20px #c084fc,0 0 40px #c084fc;transform:scale(1.1);}
}

#options .option{
  border:2px solid var(--outline);
  border-radius:var(--radius);
  padding:1rem;
  margin:0.5rem 0;
  width:100%;
  font-size:clamp(1.1rem,4vw,1.4rem);
  font-weight:700;
  background:#00000020;
  color:#fff;
  cursor:pointer;
  transition:opacity .2s,background .3s;
}
#hintBox{
  margin-top:.8rem;
  font-size:1rem;
  color:#fdd86d;
  text-shadow:var(--goldGlow);
  line-height:1.4;
}
#hintBox small{display:block;color:#ffe27a;margin-top:4px;}

.btnRow{
  display:flex;
  gap:1rem;
  justify-content:center;
  margin-top:1rem;
  flex-direction:column;
  align-items:center;
}
.nextBtn,.pointsBtn{
  padding:.7rem 1.8rem;
  border-radius:var(--radius);
  color:#000;
  font-weight:900;
  font-family:'Cinzel',serif;
  font-size:1.1rem;
  border:none;
  cursor:pointer;
  display:none;
}
.pointsBtn{
  background:linear-gradient(135deg,#93c5fd,#3b82f6);
  animation:blueShimmer 2s infinite;
}
.nextBtn{
  background:linear-gradient(135deg,#f9a8d4,#ec4899);
  animation:pinkShimmer 2s infinite;
}
@keyframes blueShimmer{
  0%,100%{box-shadow:0 0 10px #93c5fd,0 0 20px #3b82f6;}
  50%{box-shadow:0 0 20px #60a5fa,0 0 40px #2563eb;}
}
@keyframes pinkShimmer{
  0%,100%{box-shadow:0 0 10px #f9a8d4,0 0 20px #ec4899;}
  50%{box-shadow:0 0 20px #f472b6,0 0 40px #db2777;}
}

#pointsContainer{
  display:flex;
  flex-direction:column;
  align-items:center;
  margin-top:0.8rem;
}
#pointsCircle{
  width:90px;
  height:90px;
  border-radius:50%;
  background:linear-gradient(135deg,var(--gold1),var(--gold2));
  display:flex;
  align-items:center;
  justify-content:center;
  font-family:'Cinzel',serif;
  font-size:2rem;
  font-weight:900;
  box-shadow:var(--goldGlow);
  position:relative;
  overflow:hidden;
  text-shadow:0 0 10px #fff,0 0 20px #fff;
  z-index:1;
}
#pointsCircle span{position:relative;z-index:2;color:#000;}
#pointsCircle::after{
  content:'';
  position:absolute;
  width:140%;
  height:140%;
  background:radial-gradient(circle at 50% 50%,rgba(255,255,255,0.6) 0%,rgba(255,255,255,0) 70%);
  animation:pulse 2.5s infinite ease-in-out;
  z-index:0;
}
@keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.3);opacity:0.6;}}
#scoreLabel{
  margin-top:8px;
  font-family:'Cinzel',serif;
  font-size:1rem;
  color:#fdd86d;
  text-shadow:var(--goldGlow);
  animation:goldShimmer 2s infinite;
}
@keyframes goldShimmer{
  0%,100%{text-shadow:0 0 8px #facc15,0 0 20px #fde68a;}
  50%{text-shadow:0 0 14px #ffef9f,0 0 30px #fde68a;}
}
#counter{
  margin-top:4px;
  font-family:'Cinzel',serif;
  color:#fff;
  font-size:1rem;
  text-shadow:0 0 6px rgba(255,255,255,.4);
}
footer{
  text-align:center;
  color:#fff;
  padding:16px 0 22px;
  font-family:'Cinzel',serif;
  font-weight:900;
  font-size:clamp(14px,2.8vw,20px);
}

/* ğŸ”˜ Standard Booha QUIT button (small version) */
.top-nav-btn{
  position:fixed;
  top:10px;
  left:10px;
  z-index:12001;
  border-radius:999px;
  padding:6px 14px;
  border:1px solid #ffffff66;
  background:rgba(15,23,42,.95);
  color:#fff;
  font-size:.78rem;
  font-weight:700;
  letter-spacing:.04em;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:4px;
  box-shadow:0 0 12px rgba(0,0,0,.6);
  backdrop-filter:blur(4px);
}
.top-nav-btn .jp{font-size:.72em;}
.top-nav-btn .en{font-size:.8em;}

/* â“ Glowing help button */
.help-btn{
  position:fixed;
  top:10px;
  right:10px;
  z-index:12001;
  width:40px;
  height:40px;
  border-radius:999px;
  border:1px solid #ffffff88;
  background:radial-gradient(circle at 30% 30%,#7dd3fc,#1e3a8a 65%,#020617 100%);
  color:#fff;
  font-weight:900;
  font-size:20px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:
    0 0 12px rgba(125,211,252,.9),
    0 0 28px rgba(59,130,246,.9),
    0 0 52px rgba(56,189,248,.9);
  backdrop-filter:blur(4px);
}

/* ğŸªŸ Help modal */
.help-modal{
  position:fixed;
  inset:0;
  z-index:12000;
  display:none;
  align-items:center;
  justify-content:center;
}
.help-modal.show{display:flex;}
.help-backdrop{
  position:absolute;
  inset:0;
  background:rgba(15,23,42,.8);
  backdrop-filter:blur(6px);
}
.help-dialog{
  position:relative;
  z-index:1;
  max-width:720px;
  width:calc(100% - 32px);
  max-height:80vh;
  border-radius:20px;
  border:1px solid #ffffff33;
  background:radial-gradient(circle at top,#111827,#020617 55%);
  box-shadow:0 22px 70px rgba(0,0,0,.9);
  padding:18px 18px 20px;
  display:flex;
  flex-direction:column;
}
.help-dialog h2{
  font-family:'Cinzel',serif;
  font-size:1.2rem;
  text-align:center;
  margin-bottom:6px;
}
.help-sub{
  font-size:.85rem;
  text-align:center;
  color:#c7d2fe;
  margin-bottom:10px;
}
.help-body{
  margin-top:6px;
  padding-right:4px;
  font-size:.9rem;
  line-height:1.6;
  color:#e5e7f5;
  overflow-y:auto;
}
.help-body h3{
  font-size:.9rem;
  margin:10px 0 4px;
  color:#bfdbfe;
}
.help-body ul{
  padding-left:1.1rem;
  margin:4px 0 10px;
}
.help-body li{
  margin-bottom:4px;
}
.help-close{
  position:absolute;
  top:8px;
  right:10px;
  border:none;
  background:transparent;
  color:#e5e7f5;
  font-size:22px;
  cursor:pointer;
}
@media (max-width:480px){
  .help-dialog{
    max-height:82vh;
    padding:16px 14px 18px;
  }
}
</style>
</head>
<body>

<!-- ğŸ”˜ Quit + â“ Help -->
<button type="button" class="top-nav-btn" onclick="window.location.href='index.html'">
  <span class="jp">ã‚„ã‚ã‚‹</span>
  <span class="en">QUIT</span>
</button>
<button id="helpBtn" type="button" class="help-btn">?</button>

<header>
  <div class="h1">THE BOO-RICULUM</div>
  <div class="h2">Eigo Adventure â€“ January Week 1</div>
  <div class="h3">ï¼‘æœˆç¬¬ï¼‘é€± â€“ è‹±èªã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼</div>
</header>

<main>
 <div class="sageWrapper">
  <div class="playBtn" id="playBtn"></div>
  <div id="sageBox"><div id="sageText"></div></div>
 </div>
 <div class="studentWrapper">
  <div id="studentBox"></div>
  <div class="micBtn" id="micBtn"></div>
 </div>
 <div id="options"></div>
 <div id="hintBox"></div>

 <div class="btnRow">
  <button class="pointsBtn" id="pointsBtn">Points</button>
  <div id="pointsContainer">
    <div id="pointsCircle"><span id="pointsValue">0</span></div>
    <div id="scoreLabel">SCORE</div>
    <div id="counter">1 / 15</div>
  </div>
  <button class="nextBtn" id="nextBtn">Next â–¶</button>
 </div>
</main>

<footer>Bryanâ€™s English School</footer>

<!-- â“ Help popup -->
<div id="helpModal" class="help-modal" aria-hidden="true">
  <div class="help-backdrop" data-close-help></div>
  <div class="help-dialog">
    <button class="help-close" type="button" data-close-help>Ã—</button>
    <h2>How to Play ï¼ éŠã³æ–¹</h2>
    <div class="help-sub">Booha Eigo Adventure Game</div>
    <div class="help-body">
      <h3>English</h3>
      <ul>
        <li>Tap the <strong>gold â–¶ button</strong> to hear Sage ask a question in English.</li>
        <li>Look at the four answer sentences on the screen.</li>
        <li>When youâ€™re ready, tap the <strong>mic button ğŸ¤</strong> and <strong>say the correct answer sentence</strong> in English.</li>
        <li>The white box shows what the computer hears. Try to match the sentence as closely as you can.</li>
        <li>If you say the <strong>correct answer</strong>, you get points, confetti, and a reaction sound.</li>
        <li>After the first correct answer, it switches to <strong>Points Mode</strong>. Say the other funny sentences to get extra points.</li>
        <li>When you finish all sentences for that question, tap <strong>Next</strong> to go to the next adventure.</li>
      </ul>

      <h3>æ—¥æœ¬èª</h3>
      <ul>
        <li><strong>é‡‘è‰²ã® â–¶ ãƒœã‚¿ãƒ³</strong>ã‚’æŠ¼ã™ã¨ã€Sage ãŒè‹±èªã§è³ªå•ã‚’ã—ã¦ãã‚Œã¾ã™ã€‚</li>
        <li>ç”»é¢ã«ã‚ã‚‹ï¼”ã¤ã®è‹±æ–‡ã‚’ã‚ˆãè¦‹ã¦ã€æ­£ã—ã„ç­”ãˆã‚’é¸ã³ã¾ã™ã€‚</li>
        <li>æº–å‚™ãŒã§ããŸã‚‰ã€<strong>ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ ğŸ¤</strong>ã‚’æŠ¼ã—ã¦ã€<strong>æ­£ã—ã„è‹±æ–‡ã‚’å£°ã«å‡ºã—ã¦èª­ã¿ã¾ã™</strong>ã€‚</li>
        <li>ç™½ã„ãƒœãƒƒã‚¯ã‚¹ã«ã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãŒèãå–ã£ãŸè‹±èªãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã§ãã‚‹ã ã‘åŒã˜è‹±æ–‡ã«ãªã‚‹ã‚ˆã†ã«è©±ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</li>
        <li><strong>æ­£ã—ã„æ–‡</strong>ãŒè¨€ãˆãŸã‚‰ã€ãƒã‚¤ãƒ³ãƒˆã¨ç´™ãµã¶ãã€ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³éŸ³ãŒã‚‚ã‚‰ãˆã¾ã™ã€‚</li>
        <li>æœ€åˆã®æ­£è§£ã®ã‚ã¨ã€<strong>ãƒã‚¤ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰</strong>ã«ãªã‚Šã¾ã™ã€‚ã»ã‹ã®ãŠã‚‚ã—ã‚ã„æ–‡ã‚’è¨€ã£ã¦ã€è¿½åŠ ãƒã‚¤ãƒ³ãƒˆã‚’ã­ã‚‰ã„ã¾ã—ã‚‡ã†ã€‚</li>
        <li>ãã®å•é¡Œã®æ–‡ã‚’å…¨éƒ¨ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ãŸã‚‰ã€<strong>Nextï¼ˆã¤ãã¸ï¼‰</strong>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦æ¬¡ã®å†’é™ºã«é€²ã¿ã¾ã™ã€‚</li>
      </ul>

      <h3>Mic &amp; Browser ï¼ ãƒã‚¤ã‚¯ã¨ãƒ–ãƒ©ã‚¦ã‚¶</h3>
      <ul>
        <li>ãƒã‚¤ã‚¯ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’<strong>è¨±å¯</strong>ã—ãªã„ã¨ã€éŸ³å£°èªè­˜ã¯å‹•ãã¾ã›ã‚“ã€‚</li>
        <li>ã§ãã‚Œã° <strong>Chrome ã¾ãŸã¯ Edge ã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³</strong>ã§ãƒ—ãƒ¬ã‚¤ã—ã¦ãã ã•ã„ã€‚</li>
      </ul>
    </div>
  </div>
</div>

<script>
const DING="assets/audio/ding.mp3";
const EIGO="assets/audio/eigo.mp3";
const PRAISE=['yesgoodjob.mp3','perfectenglish.mp3','wownicework.mp3'];
const TRY_AGAIN=['hmmtryagain.mp3','whatlanguagewasthat.mp3','doyouhaveacookieinyourmouth.mp3'];
const EXTRA_PRAISE=['nicework.mp3','goodtry.mp3','keepgoing.mp3'];

let questions=[
 {q:"What do you eat for breakfast?",a:0,audio:"whatdoyoueatforbreakfast.mp3",answers:[
  "I eat rice and miso soup for breakfast.","I eat curry for breakfast.","I eat toothpaste for breakfast.","I eat pencils and notebooks for breakfast."]},
 {q:"What do you do after school?",a:0,audio:"whatdoyoudoafterschool.mp3",answers:[
  "I do my homework after school.","I climb trees after school.","I build a spaceship after school.","I wrestle with ghosts after school."]},
 {q:"What time do you wake up?",a:0,audio:"whattimedoyouwakeup.mp3",answers:[
  "I wake up at 7 o'clock.","I sleep until midnight.","I wake up on the moon.","I wake up when my cat starts singing."]},
 {q:"How do you go to school?",a:0,audio:"howdoyougotoschool.mp3",answers:[
  "I go to school by bus.","I go to school by rocket.","I go to school on a flying carpet.","I go to school by penguin."]},
 {q:"What do you drink in the morning?",a:0,audio:"whatdoyoudrinkinthemorning.mp3",answers:[
  "I drink milk in the morning.","I drink tomato soup in the morning.","I drink hot glue in the morning.","I drink air in the morning."]},
 {q:"What do you do before bed?",a:0,audio:"whatdoyoudobeforebed.mp3",answers:[
  "I brush my teeth before bed.","I brush my shoes before bed.","I play soccer before bed.","I eat spaghetti before bed."]},
 {q:"What do you do on weekends?",a:0,audio:"whatdoyoudoonweekends.mp3",answers:[
  "I play games on weekends.","I study math all night.","I climb Mount Fuji every weekend.","I wash my dogâ€™s homework."]},
 {q:"What time do you go to bed?",a:0,audio:"whattimedoyougotobed.mp3",answers:[
  "I go to bed at 9 o'clock.","I go to bed in the morning.","I go to bed on the bus.","I go to bed in the refrigerator."]},
 {q:"What do you have for lunch?",a:0,audio:"whatdoyouhaveforlunch.mp3",answers:[
  "I have curry and rice for lunch.","I have cake and cookies for lunch.","I have ice cubes for lunch.","I have crayons for lunch."]},
 {q:"What do you do in the evening?",a:0,audio:"whatdoyoudointheevening.mp3",answers:[
  "I watch TV in the evening.","I swim in my bathtub in the evening.","I chase ghosts in the evening.","I do jumping jacks on the roof."]},
 {q:"What do you do on Monday?",a:0,audio:"whatdoyoudoonmonday.mp3",answers:[
  "I study English on Monday.","I dance with my teacher on Monday.","I fly to the moon on Monday.","I eat noodles on the roof on Monday."]},
 {q:"What do you do after dinner?",a:0,audio:"whatdoyoudoafterdinner.mp3",answers:[
  "I take a bath after dinner.","I do my taxes after dinner.","I chase my cat after dinner.","I eat more dinner after dinner."]},
 {q:"What time do you eat dinner?",a:0,audio:"whattimedoyoueatdinner.mp3",answers:[
  "I eat dinner at 7 o'clock.","I eat dinner at midnight.","I eat dinner at school.","I eat dinner while running."]},
 {q:"What do you do on Sunday?",a:0,audio:"whatdoyoudoonsunday.mp3",answers:[
  "I go shopping on Sunday.","I do push-ups in the park on Sunday.","I scare my brother on Sunday.","I ride a unicorn on Sunday."]},
 {q:"Who do you eat dinner with?",a:0,audio:"whodoyoueatdinnerwith.mp3",answers:[
  "I eat dinner with my family.","I eat dinner with my pet rock.","I eat dinner with my teacherâ€™s ghost.","I eat dinner with my shadow."]}
];

// --- Shuffle and assign correct answer text ---
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
questions=shuffle(questions.map(q=>{const correct=q.answers[q.a];const mixed=shuffle([...q.answers]);return {...q,answers:mixed,correct};}));

let current=0,points=0,listening=false,gotCorrect=false,pointsMode=false,firstAttempt=true;
let recog,remainingIncorrect=new Set();

const $=s=>document.querySelector(s);
const sageText=$('#sageText'),studentBox=$('#studentBox'),playBtn=$('#playBtn'),
micBtn=$('#micBtn'),optionsBox=$('#options'),hintBox=$('#hintBox'),
nextBtn=$('#nextBtn'),pointsBtn=$('#pointsBtn'),pointsCircle=$('#pointsCircle'),
pointsValue=$('#pointsValue'),counter=$('#counter');

function playAudio(f){return new Promise(r=>{const a=new Audio(f.includes('/')?f:'audio/'+f);a.onended=r;a.onerror=r;a.play().catch(r);});}
function pulsePoints(){pointsCircle.style.transform='scale(1.3)';setTimeout(()=>pointsCircle.style.transform='scale(1)',300);}
function updateUI(){pointsValue.textContent=points;counter.textContent=(current+1)+' / '+questions.length;}
function animateWords(t){sageText.innerHTML='';t.split(' ').forEach((w,i)=>{const s=document.createElement('span');s.className='word';s.textContent=w;sageText.appendChild(s);setTimeout(()=>s.style.opacity=1,180*i);});}

/* ğŸ™ï¸ Normalization â€“ more forgiving with apostrophes and 's / s
   - Converts â€™ â€˜ Â´ ` to '
   - Turns "dog's" â†’ "dogs"
   - Removes remaining apostrophes
   - Keeps only letters, numbers, spaces
*/
function normalize(s){
  return s
    .toLowerCase()
    .replace(/[â€™â€˜Â´`]/g,"'")
    .replace(/'s\b/g,"s")   // treat dogâ€™s / dog's as dogs
    .replace(/'/g,"")       // drop any remaining apostrophes
    .replace(/[^a-z0-9\s]/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}

function confetti(n=80){
  for(let i=0;i<n;i++){
    const c=document.createElement('div');
    c.style.cssText=`position:fixed;width:10px;height:10px;left:${Math.random()*100}%;top:-10px;background:hsl(${Math.random()*360},100%,70%);opacity:.9;pointer-events:none;`;
    document.body.appendChild(c);
    const d=900+Math.random()*1200;
    c.animate([{transform:'translateY(0)'},{transform:'translateY(100vh) rotate(720deg)'}],{duration:d,easing:'ease-out'});
    setTimeout(()=>c.remove(),d);
  }
}
async function shakeRedErase(){
  studentBox.classList.add('shake');
  studentBox.style.background='#ef4444';
  await playAudio('audio/'+TRY_AGAIN[Math.floor(Math.random()*TRY_AGAIN.length)]);
  setTimeout(()=>{
    studentBox.classList.remove('shake');
    studentBox.style.background='#fff';
    studentBox.textContent='';
  },650);
}
function strictMatch(s,a){
  const ns=normalize(s),na=normalize(a);
  if(!ns||!na)return false;
  const sa=ns.split(' '),aa=na.split(' ');
  const overlap=aa.filter(w=>sa.includes(w)).length;
  const extra=sa.filter(w=>!aa.includes(w));
  return overlap/aa.length>=0.9&&extra.length<=2;
}
function initRecog(){
  const R=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!R){alert('Speech Recognition not supported');return;}
  recog=new R();
  recog.lang='en-US';
  recog.interimResults=true;
  recog.onstart=()=>{studentBox.classList.add('glow');listening=true;};
  recog.onend=()=>{studentBox.classList.remove('glow');listening=false;};
  recog.onresult=e=>{
    let t='';
    for(const r of e.results){
      t+=r[0].transcript+' ';
      if(r.isFinal)checkSpeech(t.trim());
    }
    studentBox.textContent=t.trim();
  };
}
function startMic(){if(!recog)initRecog();if(!listening)try{recog.start();}catch{}}
async function playQuestion(){
  const q=questions[current];
  animateWords(q.q);
  await playAudio('audio/'+q.audio);
  firstAttempt=true;
  startMic();
}
function renderAnswers(){
  optionsBox.innerHTML='';
  const q=questions[current];
  q.answers.forEach((a,i)=>{
    const d=document.createElement('div');
    d.className='option';
    d.dataset.index=i;
    d.textContent=a;
    optionsBox.appendChild(d);
  });
}

async function checkSpeech(spoken){
 const q=questions[current];
 let matchIndex=q.answers.findIndex(ans=>strictMatch(spoken,ans));
 if(matchIndex===-1){
   firstAttempt=false;
   await shakeRedErase();
   return;
 }
 const matchedText=q.answers[matchIndex];
 const optEl=document.querySelector(`.option[data-index="${matchIndex}"]`);

 // âœ… Correct answer check by text (now tolerant to dog's / dogs etc.)
 if(!pointsMode && !gotCorrect && strictMatch(spoken,q.correct)){
   gotCorrect=true;
   await playAudio('audio/'+PRAISE[Math.floor(Math.random()*PRAISE.length)]);
   confetti(60);
   await playAudio(DING);
   points+=firstAttempt?5:1;
   pulsePoints();
   updateUI();
   optEl?.remove();
   studentBox.textContent='';
   remainingIncorrect=new Set(q.answers.filter(a=>a!==q.correct));
   pointsMode=true;
   pointsBtn.style.display='inline-block';
   hintBox.innerHTML='Points mode â€“ say the other 3 sentences!<small>ãƒã‚¤ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚ã®ã“ã‚Šï¼“ã¤ã®ã¶ã‚“ã‚’ã„ã£ã¦ã¿ã‚ˆã†ï¼</small>';
   return;
 }
 if(!pointsMode){
   firstAttempt=false;
   await shakeRedErase();
   return;
 }
 if(pointsMode){
   if(remainingIncorrect.has(matchedText)){
     remainingIncorrect.delete(matchedText);
     await playAudio('audio/'+EXTRA_PRAISE[Math.floor(Math.random()*EXTRA_PRAISE.length)]);
     confetti(90);
     await playAudio(EIGO);
     points+=1;
     pulsePoints();
     updateUI();
     optEl?.remove();
     studentBox.textContent='';
     if(remainingIncorrect.size===0){
       pointsBtn.style.display='none';
       nextBtn.style.display='inline-block';
       hintBox.textContent='Great job! Tap Next.';
     }
   } else {
     await shakeRedErase();
   }
 }
 studentBox.textContent='';
}

function loadQuestion(){
  gotCorrect=false;
  pointsMode=false;
  firstAttempt=true;
  remainingIncorrect.clear?.();
  pointsBtn.style.display='none';
  nextBtn.style.display='none';
  hintBox.textContent='';
  sageText.textContent='';
  studentBox.textContent='';
  renderAnswers();
  updateUI();
}
playBtn.onclick=()=>playQuestion();
micBtn.onclick=()=>{
  if(!recog)initRecog();
  if(listening)recog.stop();
  else startMic();
};
nextBtn.onclick=()=>{
  current++;
  if(current>=questions.length)current=0;
  loadQuestion();
};
window.onload=loadQuestion;

/* ---------- HELP MODAL ---------- */
const helpBtn=$('#helpBtn');
const helpModal=$('#helpModal');
if(helpBtn && helpModal){
  const closeEls=helpModal.querySelectorAll('[data-close-help]');
  const openHelp=()=>{helpModal.classList.add('show');helpModal.setAttribute('aria-hidden','false');};
  const closeHelp=()=>{helpModal.classList.remove('show');helpModal.setAttribute('aria-hidden','true');};
  helpBtn.addEventListener('click',openHelp);
  closeEls.forEach(el=>el.addEventListener('click',closeHelp));
  helpModal.addEventListener('click',e=>{if(e.target===helpModal)closeHelp();});
  document.addEventListener('keydown',e=>{if(e.key==='Escape')closeHelp();});
}
</script>
</body>
</html>
